<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>HSAlib &mdash; IrodsShare 0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="IrodsShare 0.1 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">IrodsShare 0.1 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for HSAlib</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The HSAccess library implements access control logic for scientific data sharing. It includes</span>

<span class="sd">1. user registration and privilege handling</span>

<span class="sd">2. group creation and management</span>

<span class="sd">3. resource registration and access control. </span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Alva Couch&#39;</span>


<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">import</span> <span class="nn">psycopg2.extras</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>


<span class="c">##################################################################</span>
<span class="c"># assertion logic for filesystem protection model</span>
<span class="c"># This code implements a filesystem protection model.</span>
<span class="c"># It is in essence a data model; the routines herein are</span>
<span class="c"># get and put methods for various kinds of data.</span>
<span class="c"># The key to the interface is an idempotent assertion model</span>
<span class="c"># in which repeating an assertion has no effect.</span>
<span class="c"># Assertions are facts about the protection of resources.</span>
<span class="c"># An assertion is either made true, or an exception is raised</span>
<span class="c"># indicating why it cannot be made true.</span>
<span class="c">##################################################################</span>
<span class="c"># to be done:</span>
<span class="c"># deep logic for ownership: do not allow the last owner to disown</span>
<span class="c"># - for groups</span>
<span class="c"># - for resources</span>
<span class="c"># turn off privileges for</span>
<span class="c"># - inactive groups</span>
<span class="c"># - inactive users</span>
<span class="c"># invite/accept logic for groups</span>
<span class="c"># access control for groups: don&#39;t allow unauthorized people to ls</span>
<span class="c"># rationalize group membership: one database rather than two</span>
<span class="c">##################################################################</span>

<span class="c"># exception class specifically for access control exceptions</span>


<span class="k">class</span> <span class="nc">HSAException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception class for HSAccess class: documents prohibited actions according to HSAccess engine logic</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the exception value to a given string. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="c"># class encapsulates all access control actions</span>


<div class="viewcode-block" id="HSAccess"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess">[docs]</a><span class="k">class</span> <span class="nc">HSAccess</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Access control class for HydroShare Resources, Groups</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_PRIVILEGE_NONE</span> <span class="o">=</span> <span class="mi">100</span>          <span class="c"># code that no privilege is asserted</span>
    <span class="n">_PRIVILEGE_OWN</span> <span class="o">=</span> <span class="mi">1</span>             <span class="c"># owner of thing</span>
    <span class="n">_PRIVILEGE_RW</span> <span class="o">=</span> <span class="mi">2</span>              <span class="c"># can read and write thing</span>
    <span class="n">_PRIVILEGE_RO</span> <span class="o">=</span> <span class="mi">3</span>              <span class="c"># can read thing</span>
    <span class="n">_PRIVILEGE_NS</span> <span class="o">=</span> <span class="mi">4</span>              <span class="c"># can read but not share with others</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">irods_user</span><span class="p">,</span> <span class="n">irods_password</span><span class="p">,</span>
                 <span class="n">db_database</span><span class="p">,</span> <span class="n">db_user</span><span class="p">,</span> <span class="n">db_password</span><span class="p">,</span> <span class="n">db_host</span><span class="p">,</span> <span class="n">db_port</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_irods_user</span> <span class="o">=</span> <span class="n">irods_user</span>
            <span class="c"># print &#39;irods_user is &#39;, irods_user</span>
            <span class="c"># could authenticate against irods here</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">db_database</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">db_user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">db_password</span><span class="p">,</span>
                                          <span class="n">host</span><span class="o">=</span><span class="n">db_host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">db_port</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">cursor_factory</span><span class="o">=</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">DictCursor</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;unable to connect to the database&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_login</span><span class="p">(</span><span class="n">irods_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_uuid_from_login</span><span class="p">(</span><span class="n">irods_user</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c">###########################################################</span>
    <span class="c"># user handling</span>
    <span class="c">###########################################################</span>

    <span class="c">###########################################################</span>
    <span class="c"># fetch a list of all user logins</span>
    <span class="c"># CLI: hs_users</span>
    <span class="c">###########################################################</span>

    <span class="k">def</span> <span class="nf">_get_user_logins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: Get a list of all registered user logins</span>

<span class="sd">        :return: list: of login names</span>

<span class="sd">        Gets a list of user login names. These are used internally as unique </span>
<span class="sd">        identifiers but not accepted as command parameters. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT user_login FROM users&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;user_login&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c">###########################################################</span>
    <span class="c"># fetch a list of all user metadata</span>
    <span class="c"># CLI: hs_users</span>
    <span class="c">###########################################################</span>
<div class="viewcode-block" id="HSAccess.get_users"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_users">[docs]</a>    <span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the registered user list</span>

<span class="sd">        :return: list of user metadata dictionaries</span>

<span class="sd">        Return format is a list of dictionaries of the form::</span>

<span class="sd">            {</span>
<span class="sd">            &#39;login&#39;: *user_login*,</span>
<span class="sd">            &#39;uuid&#39;: *user uuid*,</span>
<span class="sd">            &#39;name&#39;: *user name*,</span>
<span class="sd">            &#39;active&#39;: *true if user is active*,</span>
<span class="sd">            &#39;admin&#39;:  *true if user is admin* </span>
<span class="sd">            }</span>
<span class="sd">        </span>
<span class="sd">        These entries can be edited and used as input to &#39;assert_user_metadata&#39;. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT user_uuid, user_login, user_name, user_active, user_admin FROM users&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s">&#39;login&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_login&#39;</span><span class="p">],</span>
                    <span class="s">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_uuid&#39;</span><span class="p">],</span>
                    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_name&#39;</span><span class="p">],</span>
                    <span class="s">&#39;active&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_active&#39;</span><span class="p">],</span>
                    <span class="s">&#39;admin&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_admin&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="HSAccess.get_user_metadata"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_user_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get metadata for a user as a dict record</span>

<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param user_uuid: uuid of user for which to fetch metadata; If None, then return data on current user. </span>
<span class="sd">        :return: Dict of metadata for the login specified</span>

<span class="sd">        This gives more complete information than &#39;get_users&#39;, including the date of user creation. </span>
<span class="sd">        The extra data is not utilize in &#39;assert_user_metadata&#39;. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> 
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select u.user_login, u.user_uuid, u.user_name, u.user_active, u.user_admin,</span>
<span class="s">          a.user_login as user_assertion_login, a.user_uuid as user_assertion_uuid, u.assertion_time</span>
<span class="s">          from users u left join users a on u.assertion_user_id = a.user_id</span>
<span class="s">          where u.user_uuid=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_uuid</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific user login&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&#39;uuid&#39;</span><span class="p">:</span>  <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_uuid&#39;</span><span class="p">],</span>
                    <span class="s">&#39;login&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_login&#39;</span><span class="p">],</span>
                    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_name&#39;</span><span class="p">],</span>
                    <span class="s">&#39;active&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_active&#39;</span><span class="p">],</span>
                    <span class="s">&#39;admin&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_admin&#39;</span><span class="p">],</span>
                    <span class="s">&#39;asserting_login&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_assertion_login&#39;</span><span class="p">],</span>
                    <span class="s">&#39;asserting_uuid&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_assertion_uuid&#39;</span><span class="p">],</span>
                    <span class="s">&#39;assertion_time&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;assertion_time&#39;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;no such user uuid &quot;</span> <span class="o">+</span> <span class="n">user_uuid</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HSAccess.assert_user_metadata"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.assert_user_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">assert_user_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert changes in user metadata</span>

<span class="sd">        :type metadata: dict&lt;str, str&gt; </span>
<span class="sd">        :param metadata: a metadata record returned by get_user_metadata</span>
<span class="sd">        :return:</span>

<span class="sd">        Permissible assertions are those permissible to the currently logged-in user. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_uuid</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;uuid&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;user does not exist&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Cannot assert metadata for user other than self: operation requires privilege&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;admin&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;cannot raise non-admin to admin without admin privilege&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;active&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;only administrative users can deactivate a user&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_user</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s">&#39;login&#39;</span><span class="p">],</span> <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
                         <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;active&#39;</span><span class="p">],</span> <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;admin&#39;</span><span class="p">],</span> <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;uuid&#39;</span><span class="p">])</span>

    <span class="c"># get a specific login id for use as an entity id for recording actions</span></div>
    <span class="k">def</span> <span class="nf">_get_user_id_from_login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: get user database id from login name</span>

<span class="sd">        :type login: str</span>
<span class="sd">        :param login: string login name</span>
<span class="sd">        :return: integer user id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select user_id from users where user_login=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">login</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific user login&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;user_id&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;User login &#39;&quot;</span> <span class="o">+</span> <span class="n">login</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>

    <span class="c"># get a specific login id for use as an entity id for recording actions</span>
    <span class="k">def</span> <span class="nf">_get_user_id_from_uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: get user database id from user uuid</span>

<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param user_uuid: uuid of user; omit to report on current user </span>
<span class="sd">        :return: int: user id</span>

<span class="sd">        The return value of this function is used as the internal key in the </span>
<span class="sd">        access control database, but never, ever exposed to users. It is </span>
<span class="sd">        an integer for speed of joins. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select user_id from users where user_uuid=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_uuid</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific user uuid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;user_id&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;User uuid &#39;&quot;</span> <span class="o">+</span> <span class="n">user_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>

    <span class="c"># get a specific login for use as a logging aid</span>
    <span class="k">def</span> <span class="nf">_get_user_login_from_uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: get user login name from user uuid e</span>

<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param user_uuid: uuid of user; omit to report on current user </span>
<span class="sd">        :return: str: user login</span>

<span class="sd">        This returns the login name for a given user uuid. This is currently an iRODS login and has no </span>
<span class="sd">        meaning in the system. It is used as a last resort in &#39;assert_user&#39; to insure that we do not </span>
<span class="sd">        create users with identical login names, but is otherwise ignored. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select user_login from users where user_uuid=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_uuid</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific user uuid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;user_login&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;User uuid &#39;&quot;</span> <span class="o">+</span> <span class="n">user_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>

    <span class="c"># get a specific login uuid for use in requesting actions</span>
    <span class="k">def</span> <span class="nf">_get_user_uuid_from_login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: get user database id from login name</span>

<span class="sd">        :type login: str</span>
<span class="sd">        :param login: string login name</span>
<span class="sd">        :return: str: user uuid</span>

<span class="sd">        This returns the user uuid from the login name. While this works reliably </span>
<span class="sd">        because login names are unique, this is only used to construct test cases. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select user_uuid from users where user_login=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">login</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific user login&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;user_uuid&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;User login &#39;&quot;</span> <span class="o">+</span> <span class="n">login</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>

    <span class="c"># test whether a login exists without recovering its id or metadata</span>
<div class="viewcode-block" id="HSAccess.user_exists"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.user_exists">[docs]</a>    <span class="k">def</span> <span class="nf">user_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine whether a login name is registered in the HSAccess database</span>

<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param user_uuid: uuid of user; omit to report on current user </span>
<span class="sd">        :return: bool: True if user exists</span>

<span class="sd">        This checks a uuid and returns True if it exists. This is used to avoid </span>
<span class="sd">        unintentional exceptions from use of a non-existent uuid. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select user_id from users where user_uuid=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_uuid</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific user uuid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="c"># test whether a user login has administrative privileges</span></div>
<div class="viewcode-block" id="HSAccess.user_is_admin"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.user_is_admin">[docs]</a>    <span class="k">def</span> <span class="nf">user_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine whether a user identified by uuid has admin privileges</span>

<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param user_uuid: uuid of user; omit to report on current user </span>
<span class="sd">        :return: bool</span>

<span class="sd">        This reports whether the given user has administrative privileges. </span>
<span class="sd">        Administrative users can, for example: </span>

<span class="sd">        1. register new users with &#39;assert_user&#39;</span>

<span class="sd">        2. impersonate a given user and perform selected operations by proxy for the user. </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select user_admin from users where user_uuid=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_uuid</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific user uuid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;user_admin&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;user uuid &#39;&quot;</span> <span class="o">+</span> <span class="n">user_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>

    <span class="c"># test whether a user login is entitled to make changes</span></div>
<div class="viewcode-block" id="HSAccess.user_is_active"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.user_is_active">[docs]</a>    <span class="k">def</span> <span class="nf">user_is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine whether a user uuid is an active user</span>

<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param user_uuid: uuid of user; omit to report on current user </span>
<span class="sd">        :return: bool</span>

<span class="sd">        This reports whether a given user is active. Inactive users cannot login or access anything, </span>
<span class="sd">        but their privileges and owned documents are kept intact. It is legal for a resource or group </span>
<span class="sd">        to be owned by an inactive user, and groups and resources originally created by an inactive user </span>
<span class="sd">        continue to be available to others. Whether a group is active is independent of whether its </span>
<span class="sd">        owner is active. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select user_active from users where user_uuid=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_uuid</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific user uuid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;user_active&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;user uuid &#39;&quot;</span> <span class="o">+</span> <span class="n">user_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>

    <span class="c"># this is a no-frills assert of a user record without object use</span>
    <span class="c"># CLI: this will normally be done by django. But we need a debugging command</span>
    <span class="c"># &#39;hs_register_user&#39; for our own use.</span></div>
<div class="viewcode-block" id="HSAccess.assert_user"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.assert_user">[docs]</a>    <span class="k">def</span> <span class="nf">assert_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_login</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span>  <span class="n">user_active</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">user_admin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register or update the registration of a user</span>

<span class="sd">        :type user_login: str</span>
<span class="sd">        :type user_name: str</span>
<span class="sd">        :type user_active: bool</span>
<span class="sd">        :type user_admin: bool</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param user_login: user login name</span>
<span class="sd">        :param user_name: str: user print name</span>
<span class="sd">        :param user_active: bool: whether user is active</span>
<span class="sd">        :param user_admin: bool: whether user is an admin</span>
<span class="sd">        :param user_uuid: uuid to register or update; leave out to register a new user </span>
<span class="sd">        :return:</span>

<span class="sd">        This is used in two forms: </span>

<span class="sd">        1. with user_uuid absent, it attempts to register a new user. Note if the specified </span>
<span class="sd">           login is found, that is utilized as a unique key and that record is updated instead. </span>

<span class="sd">        2. with user_uuid present, it updates the metadata record for that user. </span>

<span class="sd">        The access control model disallows certain changes to this record: </span>

<span class="sd">        1. Changes to whether a user is active or an administrator can only be made by an administrative user. </span>

<span class="sd">        2. Regular users can only change their print names (user_name).</span>

<span class="sd">        :todo: check logic for what a user can change.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Asserting uuid &#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_is_active</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Asserting uuid &#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; is inactive&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;User uuid &#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
                               <span class="o">+</span> <span class="s">&quot;&#39; is not an administrator; operation requires privilege&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># try the other keys to see if it is defined</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_uuid_from_login</span><span class="p">(</span><span class="n">user_login</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">HSAException</span><span class="p">:</span>
                <span class="n">user_uuid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="c"># print &quot;resource uuid is&quot;, resource_uuid</span>

        <span class="n">assert_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assert_user_update</span><span class="p">(</span><span class="n">assert_id</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">,</span> <span class="n">user_login</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">user_active</span><span class="p">,</span> <span class="n">user_admin</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assert_user_add</span><span class="p">(</span><span class="n">assert_id</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">,</span> <span class="n">user_login</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">user_active</span><span class="p">,</span> <span class="n">user_admin</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">user_uuid</span>
</div>
    <span class="k">def</span> <span class="nf">_assert_user_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assertion_user_id</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">,</span> <span class="n">user_login</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">user_active</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">user_admin</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: add a new user record </span>

<span class="sd">        :type assertion_user_id: int</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :type user_login: str</span>
<span class="sd">        :type user_name: str</span>
<span class="sd">        :type user_active: bool</span>
<span class="sd">        :type user_admin: bool</span>
<span class="sd">        :param assertion_user_id: internal user id of user adding the login name</span>
<span class="sd">        :param user_uuid: uuid of user to add</span>
<span class="sd">        :param user_login: user login string: must be unique</span>
<span class="sd">        :param user_name: user print name</span>
<span class="sd">        :param user_active: whether user is active</span>
<span class="sd">        :param user_admin: whether user is an administrator</span>
<span class="sd">        :return:</span>

<span class="sd">        Add a new previously non-existent user record to the registered users. user_uuid and user_login </span>
<span class="sd">        must both be independently unique. </span>

<span class="sd">        This routine is not subject to access control restrictions. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;insert into users values (DEFAULT, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, DEFAULT)&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">user_uuid</span><span class="p">,</span> <span class="n">user_login</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">user_active</span><span class="p">,</span> <span class="n">user_admin</span><span class="p">,</span> <span class="n">assertion_user_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c"># this is the general idea but can be cleaned up with conditional code.</span>
    <span class="k">def</span> <span class="nf">_assert_user_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assertion_user_id</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">,</span> <span class="n">user_login</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">user_active</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                            <span class="n">user_admin</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: update an existing user record</span>

<span class="sd">        :type user_login: str</span>
<span class="sd">        :type assertion_user_id: int</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :type user_name: str</span>
<span class="sd">        :type user_active: bool</span>
<span class="sd">        :type user_admin: bool</span>
<span class="sd">        :param user_login: login of user to update (primary key)</span>
<span class="sd">        :param assertion_user_id: user adding the login name</span>
<span class="sd">        :param user_uuid: user uuid string: must be unique</span>
<span class="sd">        :param user_name: user print name</span>
<span class="sd">        :param user_active: whether user is active</span>
<span class="sd">        :param user_admin: whether user is an administrator</span>
<span class="sd">        :return:</span>

<span class="sd">        Update an existing user record in the registered users table. user_uuid and user_login must </span>
<span class="sd">        remain independently unique. </span>

<span class="sd">        This routine is not subject to access control restrictions. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;update users set user_login =</span><span class="si">%s</span><span class="s">, user_name=</span><span class="si">%s</span><span class="s">, user_active=</span><span class="si">%s</span><span class="s">, user_admin=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                          assertion_user_id=</span><span class="si">%s</span><span class="s">, assertion_time=CURRENT_TIMESTAMP</span>
<span class="s">                          where user_uuid=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">user_login</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">user_active</span><span class="p">,</span> <span class="n">user_admin</span><span class="p">,</span> <span class="n">assertion_user_id</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c">###########################################################</span>
    <span class="c"># user group handling</span>
    <span class="c">###########################################################</span>
    <span class="c"># should it be possible for a group to go inactive?</span>
    <span class="c"># answer: refactored for group_active in records; </span>
    <span class="c"># if group is not active, protections for that group are </span>
    <span class="c"># downgraded to ro from whatever they were before. </span>
    <span class="c">###########################################################</span>

    <span class="c"># fetch a list of all group uuids</span>
<div class="viewcode-block" id="HSAccess.get_groups"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_groups">[docs]</a>    <span class="k">def</span> <span class="nf">get_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get information on all existing groups</span>

<span class="sd">        :return: a list of all group uuids and names , as dictionary objects</span>

<span class="sd">        This returns a list of elements of the form::</span>

<span class="sd">            { &#39;uuid&#39;: *uuid of group*, &#39;name&#39;: *name of group* } </span>

<span class="sd">        sorted in order of group name. Group names do not have to be unique. </span>

<span class="sd">        The &#39;uuid&#39; element can be used as input to &#39;get_group_metadata&#39; to learn more about the group. </span>

<span class="sd">        Note: this method is not currently subject to access control. The access control document does</span>
<span class="sd">        not limit group visibility; just membership. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT group_uuid, group_name FROM groups ORDER BY group_name, group_uuid&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="p">[{</span><span class="s">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;group_uuid&#39;</span><span class="p">],</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;group_name&#39;</span><span class="p">]}]</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="HSAccess.get_groups_for_user"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_groups_for_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_groups_for_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of groups relevant to a specific user</span>

<span class="sd">        :param user_uuid: the user to report on; omit to report on current user. </span>
<span class="sd">        :return: list of dicts describing groups</span>

<span class="sd">        This returns a list of groups in the following format::  </span>
<span class="sd">            { &#39;name&#39;: *name of group*, &#39;uuid&#39;: *uuid of group* } ]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select g.group_uuid, g.group_name, x.privilege_code</span>
<span class="s">                          from groups g</span>
<span class="s">                          left join user_membership_in_group m on m.group_id=g.group_id</span>
<span class="s">                          left join users u on u.user_id = m.user_id</span>
<span class="s">                          left join user_group_privilege p on p.user_id=u.user_id and p.group_id=g.group_id</span>
<span class="s">                          left join privileges x on x.privilege_id=p.privilege_id</span>
<span class="s">                          where u.user_uuid=</span><span class="si">%s</span><span class="s"></span>
<span class="s">                          order by g.group_name, g.group_uuid&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">user_uuid</span><span class="p">,))</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="p">[{</span><span class="s">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;group_uuid&#39;</span><span class="p">],</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;group_name&#39;</span><span class="p">],</span> <span class="s">&#39;code&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;privilege_code&#39;</span><span class="p">]}]</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="HSAccess.get_group_metadata"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_group_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_group_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get metadata for a group as a dict record</span>

<span class="sd">        :param group_uuid: uuid of group </span>
<span class="sd">        :return: dict of group metadata </span>

<span class="sd">        This returns a dictionary record with the structure::</span>

<span class="sd">            {</span>
<span class="sd">                &#39;uuid&#39;: *uuid of group*,</span>
<span class="sd">                &#39;name&#39;: *name of group*,</span>
<span class="sd">                &#39;active&#39;: *whether group is active*, </span>
<span class="sd">                &#39;asserting_login&#39;: *login of user who last changed metadata*, </span>
<span class="sd">                &#39;asserting_uuid&#39;: *uuid of user who last changed metadata*, </span>
<span class="sd">                &#39;assertion_time&#39;: *time of last metadata change*</span>
<span class="sd">            } </span>

<span class="sd">        This value can be edited and used as an argument to &#39;assert_group_metadata&#39;. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select g.group_uuid, g.group_name, g.group_active,</span>
<span class="s">          a.user_login as user_assertion_login, a.user_uuid as user_assertion_uuid, g.assertion_time</span>
<span class="s">          from groups g left join users a on g.assertion_user_id = a.user_id</span>
<span class="s">          where g.group_uuid=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">group_uuid</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific group uuid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&#39;uuid&#39;</span><span class="p">:</span>  <span class="n">row</span><span class="p">[</span><span class="s">&#39;group_uuid&#39;</span><span class="p">],</span>
                    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;group_name&#39;</span><span class="p">],</span>
                    <span class="s">&#39;active&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;group_active&#39;</span><span class="p">],</span>
                    <span class="s">&#39;asserting_login&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_assertion_login&#39;</span><span class="p">],</span>
                    <span class="s">&#39;asserting_uuid&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_assertion_uuid&#39;</span><span class="p">],</span>
                    <span class="s">&#39;assertion_time&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;assertion_time&#39;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;no such group &quot;</span> <span class="o">+</span> <span class="n">group_uuid</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HSAccess.assert_group_metadata"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.assert_group_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">assert_group_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert changes in user metadata</span>

<span class="sd">        :param metadata: a metadata record as returned by get_group_metadata</span>
<span class="sd">        :return:</span>

<span class="sd">        This asserts changes in group metadata subject to the restrictions in &#39;assert_group&#39;.  </span>
<span class="sd">        It can be used to create new groups as well as to edit group metadata. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_group</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;active&#39;</span><span class="p">],</span> <span class="n">group_uuid</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s">&#39;uuid&#39;</span><span class="p">],</span> <span class="n">user_uuid</span><span class="o">=</span><span class="n">user_uuid</span><span class="p">)</span>

    <span class="c"># get a specific login id for use as an entity id for recording actions</span></div>
    <span class="k">def</span> <span class="nf">_get_group_id_from_uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: translate from group object identifier to database id</span>

<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :param group_uuid: group object identifier</span>
<span class="sd">        :return: int: group_id in HSAccess database</span>

<span class="sd">        This returns the private identifier for a group that is used internally as </span>
<span class="sd">        a join target. This is an integer for speed. This identifier is never exposed</span>
<span class="sd">        to users or administrators of the system. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select group_id from groups where group_uuid=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">group_uuid</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific group uuid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;group_id&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Group uuid &#39;&quot;</span> <span class="o">+</span> <span class="n">group_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>

    <span class="c"># get a specific login id for use as an entity id for recording actions</span>
    <span class="k">def</span> <span class="nf">_get_group_name_from_uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: translate from group object identifier to database id</span>

<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :param group_uuid: group object identifier</span>
<span class="sd">        :return: str: group name</span>

<span class="sd">        This returns the name of a group from its uuid. Group names are not generally unique and </span>
<span class="sd">        cannot be used as keys from which to locate groups. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select group_name from groups where group_uuid=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">group_uuid</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific group uuid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;group_name&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Group uuid &#39;&quot;</span> <span class="o">+</span> <span class="n">group_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>

    <span class="c"># test whether a login exists without recovering its id or metadata</span>
<div class="viewcode-block" id="HSAccess.group_exists"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.group_exists">[docs]</a>    <span class="k">def</span> <span class="nf">group_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine whether group identifier (uuid) is registered</span>

<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :param group_uuid: group object identifier</span>
<span class="sd">        :return: bool: whether group object identifier is registered</span>

<span class="sd">        This is used to avoid execution exceptions by ensuring that a group uuid </span>
<span class="sd">        is valid before performing further actions. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select group_id from groups where group_uuid=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">group_uuid</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific group uuid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="c"># this is a no-frills assert user without object use</span>
    <span class="c"># CLI: hs_create_group and hs_modify_group</span></div>
<div class="viewcode-block" id="HSAccess.assert_group"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.assert_group">[docs]</a>    <span class="k">def</span> <span class="nf">assert_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">group_active</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">group_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register or update a group</span>

<span class="sd">        :type group_name: str</span>
<span class="sd">        :type group_active: bool</span>
<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param group_name: str: name of group</span>
<span class="sd">        :param group_active: bool: whether group is active</span>
<span class="sd">        :param group_uuid: str: group identifier, if omitted or unset, then a new group_uuid is created and returned. </span>
<span class="sd">        :param user_uuid: user identifier; omit to utilize current user. </span>
<span class="sd">        :return: str: uuid of group just modified; created if necessary. </span>

<span class="sd">        This creates a new group subject to several conventions: </span>

<span class="sd">        1. if group_uuid is None, then a new group uuid is created.</span>

<span class="sd">        2. if user_uuid is not None and the current user has admin privilege,</span>
<span class="sd">           then the operation is undertaken on behalf of the stated user.</span>

<span class="sd">        This is also subject to access control limits: </span>

<span class="sd">        1. Any regular user can create a group </span>

<span class="sd">        2. After the group is created, a regular user can only change its name. </span>

<span class="sd">        3. All other changes to a group require administrative privilege. </span>

<span class="sd">        4. The group_uuid is set forever and cannot change. </span>

<span class="sd">        :todo: ensure that regular users cannot change too much!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Asserting login &#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_irods_user</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>
        <span class="c"># requesting_user_id = self._get_user_id_from_uuid(self._user_uuid)</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">user_uuid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Asserting login &#39;&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_irods_user</span><span class="o">+</span><span class="s">&quot;&#39; does not have admin privilege&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="c"># requesting_user_id = self._get_user_id_from_uuid(user_uuid)</span>
        <span class="k">if</span> <span class="n">group_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">group_uuid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>

        <span class="n">assert_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_exists</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_is_owned</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_assert_group_update</span><span class="p">(</span><span class="n">assert_id</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">group_active</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Insufficient privilege to complete operation&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># NEW GROUP:</span>
            <span class="c"># 1) add new group to group list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assert_group_add</span><span class="p">(</span><span class="n">assert_id</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">group_active</span><span class="p">)</span>

            <span class="c"># 2) make the asserting user the owner</span>
            <span class="c"># it is necessary to run around protections for this one step</span>
            <span class="c"># because of a chicken-and-egg problem</span>
            <span class="n">privilege_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_privilege_id_from_code</span><span class="p">(</span><span class="s">&#39;own&#39;</span><span class="p">)</span>
            <span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_id_from_uuid</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_share_group_user_add</span><span class="p">(</span><span class="n">assert_id</span><span class="p">,</span> <span class="n">assert_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">)</span>

            <span class="c"># 3) put the asserting user into the group as well.</span>
            <span class="c"># since that person is now the owner, this is straightforward.</span>
            <span class="c"># self._assert_user_in_group(group_uuid, self._user_uuid)</span>
            <span class="c"># refactoring to remove duplication among membership and access</span>
        <span class="k">return</span> <span class="n">group_uuid</span>
</div>
    <span class="k">def</span> <span class="nf">_assert_group_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assertion_user_id</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">group_active</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: add a new group to the registry</span>

<span class="sd">        :type assertion_user_id: int</span>
<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :type group_name: str</span>
<span class="sd">        :type group_active: bool</span>
<span class="sd">        :param assertion_user_id: internal id of requesting user</span>
<span class="sd">        :param group_uuid: group identifier</span>
<span class="sd">        :param group_name: name of group</span>
<span class="sd">        :param group_active: whether group is active. </span>
<span class="sd">        :return:</span>

<span class="sd">        Notes: </span>

<span class="sd">        1. This is not subject to access control. </span>

<span class="sd">        2. An exception is raised if the group uuid already exists. </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;insert into groups values (DEFAULT, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, DEFAULT)&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">group_uuid</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">group_active</span><span class="p">,</span> <span class="n">assertion_user_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_assert_group_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assertion_user_id</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">group_active</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: update a group record in the registry</span>

<span class="sd">        :type assertion_user_id: int</span>
<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :type group_name: str</span>
<span class="sd">        :type group_active: bool</span>
<span class="sd">        :param assertion_user_id: internal id of requesting user</span>
<span class="sd">        :param group_uuid: group identifier</span>
<span class="sd">        :param group_name: name of group</span>
<span class="sd">        :param group_active: group active or retired </span>
<span class="sd">        :return:</span>

<span class="sd">        Notes: </span>

<span class="sd">        1. This is not subject to access control. </span>

<span class="sd">        2. An exception is raised if the group uuid does not exist. </span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;update groups set group_name=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                          group_active=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                          assertion_user_id=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                          assertion_time=CURRENT_TIMESTAMP</span>
<span class="s">                          where group_uuid=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">group_name</span><span class="p">,</span> <span class="n">group_active</span><span class="p">,</span> <span class="n">assertion_user_id</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c"># CLI: hs_delete_group</span>
    <span class="c"># unsure whether this should be a possibility; </span>
    <span class="c"># consider deactivate_group instead. </span>
<div class="viewcode-block" id="HSAccess.retract_group"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.retract_group">[docs]</a>    <span class="k">def</span> <span class="nf">retract_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a group and all membership information</span>

<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :param group_uuid: uuid of group to delete</span>
<span class="sd">        :return:</span>

<span class="sd">        Retractions are handled via database cascade logic. This deletes all information about the </span>
<span class="sd">        group, including every resource held with that group. </span>

<span class="sd">        *Consider making a group inactive instead of using this routine.*</span>

<span class="sd">        Restrictions: </span>

<span class="sd">        1. Only the owner of the group or an administrator can do this. </span>

<span class="sd">        :todo: fix cascade logic in database so that this always works correctly. Currently </span>
<span class="sd">               there is a band-aid fix that does the cascade in the application. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># only an owner or administrator can retract a group</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_is_owned</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;cannot retract groups owned by other users&quot;</span><span class="p">)</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_id_from_uuid</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;delete from user_access_to_group where group_id=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">group_id</span><span class="p">,))</span>
        <span class="c"># user_membership_in_group is now a view</span>
        <span class="c"># self._cur.execute(&quot;&quot;&quot;delete from user_membership_in_group where group_id=%s&quot;&quot;&quot;, (group_id,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;delete from groups where group_id=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">group_id</span><span class="p">,))</span>

    <span class="c">###########################################################</span>
    <span class="c"># resource handling</span>
    <span class="c">###########################################################</span>
</div>
    <span class="k">def</span> <span class="nf">_get_resource_id_from_uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: get resource_id from resource digital identifier (uuid)</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :param resource_uuid:  resource object identifier</span>
<span class="sd">        :return: int: private resource_id in HSAccess database</span>

<span class="sd">        This returns the private and internal unique identifier of the resource object. </span>
<span class="sd">        This id is never exposed to users. </span>

<span class="sd">        Note: this method is not subject to access control. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select resource_id from resources where resource_uuid=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">resource_uuid</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific resource uuid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;resource_id&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Resource uuid &#39;&quot;</span> <span class="o">+</span> <span class="n">resource_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_resource_uuid_from_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: get resource_uuid from (unique) resource path</span>

<span class="sd">        :type resource_path: str</span>
<span class="sd">        :param resource_path: str: resource object path in iRODS</span>
<span class="sd">        :return: int: resource_uuid in HSAccess database</span>

<span class="sd">        Paths in iRODS are assumed to be unique. This does the same thing as &#39;_get_resource_id_from_uuid&#39; </span>
<span class="sd">        but for paths rather than uuids. </span>

<span class="sd">        Note: this method is not subject to access control. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select resource_uuid from resources where resource_path=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">resource_path</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific resource uuid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;resource_uuid&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Resource uuid &#39;&quot;</span> <span class="o">+</span> <span class="n">resource_path</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="HSAccess.resource_exists"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.resource_exists">[docs]</a>    <span class="k">def</span> <span class="nf">resource_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine whether a resource is registered in the database</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :param resource_uuid: resource identifier</span>
<span class="sd">        :return: bool: whether resource is registered</span>

<span class="sd">        This determines whether a given resource uuid corresponds to an existing resource. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select resource_id from resources where resource_uuid=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">resource_uuid</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific resource uuid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="HSAccess.resource_is_immutable"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.resource_is_immutable">[docs]</a>    <span class="k">def</span> <span class="nf">resource_is_immutable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Whether resource is flagged as immutable</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :param resource_uuid:  resource identifier</span>
<span class="sd">        :return: bool: whether resource has been flagged as immutable</span>

<span class="sd">        If a resource is immutable: </span>

<span class="sd">        1. All write access is denied by all users regardless of privilege. This includes</span>
<span class="sd">           resource deletion and any changes to any aspect of the resource. Even owners have no </span>
<span class="sd">           privileges other than read over an immutable resource. </span>

<span class="sd">        2. Only an administrative user can promote a resource from immutable to mutable. </span>
<span class="sd">           Other users must instead copy the resource to a new location. </span>

<span class="sd">        The spirit of the immutable flag is that the affected resource&#39;s landing page can then safely be </span>
<span class="sd">        issued a data citation. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># print &quot;checking that &quot; + login + &quot; exists&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select resource_immutable from resources where resource_uuid=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">resource_uuid</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific resource uuid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;resource_immutable&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;resource uuid &#39;&quot;</span> <span class="o">+</span> <span class="n">resource_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HSAccess.get_resource_metadata"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_resource_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_resource_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get metadata for a group as a dict record</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :param resource_uuid: group identifier for which to fetch metadata</span>
<span class="sd">        :return: dict</span>

<span class="sd">        This returns a dictionary item of the format::</span>

<span class="sd">            {</span>
<span class="sd">            &#39;title&#39;: *title of resource*,</span>
<span class="sd">            &#39;uuid&#39;: *uuid of resource*,</span>
<span class="sd">            &#39;path&#39;: *path of resource*,</span>
<span class="sd">            &#39;immutable&#39;: *whether resource is immutable*,</span>
<span class="sd">            &#39;asserting_login&#39;: *login of user who made last change to metadata*,</span>
<span class="sd">            &#39;asserting_uuid&#39;: *uuid of user who made last change to metadata*,</span>
<span class="sd">            &#39;assertion_time&#39;: *time of last change to metadata*</span>
<span class="sd">            }</span>

<span class="sd">        The record returned from &#39;get_resource_metadata&#39; is suitable for use in </span>
<span class="sd">        &#39;assert_resource_metadata&#39; and may be used for things like cloning resources. </span>
<span class="sd">        </span>
<span class="sd">        The &#39;asserting_uuid&#39; is not used during &#39;assert_resource_metadata&#39;; this is a record </span>
<span class="sd">        of &quot;who to blame&quot; for the last change. </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select r.resource_uuid, r.resource_path,</span>
<span class="s">          r.resource_title, r.resource_immutable,</span>
<span class="s">          a.user_login as user_assertion_login,</span>
<span class="s">          a.user_uuid as user_assertion_uuid,</span>
<span class="s">          r.assertion_time</span>
<span class="s">          from resources r left join users a on r.assertion_user_id = a.user_id</span>
<span class="s">          where r.resource_uuid=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">resource_uuid</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific resource uuid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;resource_title&#39;</span><span class="p">],</span>
                    <span class="s">&#39;uuid&#39;</span><span class="p">:</span>  <span class="n">row</span><span class="p">[</span><span class="s">&#39;resource_uuid&#39;</span><span class="p">],</span>
                    <span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;resource_path&#39;</span><span class="p">],</span>
                    <span class="s">&#39;immutable&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;resource_immutable&#39;</span><span class="p">],</span>
                    <span class="s">&#39;asserting_login&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_assertion_login&#39;</span><span class="p">],</span>
                    <span class="s">&#39;asserting_uuid&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_assertion_uuid&#39;</span><span class="p">],</span>
                    <span class="s">&#39;assertion_time&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;assertion_time&#39;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;no such resource &quot;</span> <span class="o">+</span> <span class="n">resource_uuid</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HSAccess.assert_resource_metadata"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.assert_resource_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">assert_resource_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert changes in resource metadata</span>

<span class="sd">        :type metadata: dict</span>
<span class="sd">        :param metadata: a metadata record as returned by get_resource_metadata</span>
<span class="sd">        :return:</span>
<span class="sd">       </span>
<span class="sd">        This is a wrapper for &#39;assert_resource&#39; that connects it to a return value </span>
<span class="sd">        format from &#39;get_resource_metadata&#39;. This can be used to edit resource</span>
<span class="sd">        fields incrementally. </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_resource</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s">&#39;uuid&#39;</span><span class="p">],</span> <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">],</span> <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">],</span> <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;immutable&#39;</span><span class="p">])</span>

    <span class="c"># a primitive resource instantiation without objects</span>
    <span class="c"># CLI: currently this can only be done properly through django</span>
    <span class="c"># but we need a debugging command &quot;hs register path&quot; for our own use</span>
</div>
<div class="viewcode-block" id="HSAccess.assert_resource"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.assert_resource">[docs]</a>    <span class="k">def</span> <span class="nf">assert_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_path</span><span class="p">,</span> <span class="n">resource_title</span><span class="p">,</span> <span class="n">resource_immutable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">resource_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add or modify a resource in the resource registry</span>

<span class="sd">        :type resource_path: str</span>
<span class="sd">        :type resource_title: str</span>
<span class="sd">        :type resource_immutable: str</span>
<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param resource_path: path to resource in iRODS  title</span>
<span class="sd">        :param resource_title: human-readable title</span>
<span class="sd">        :param resource_immutable: whether resource is immutable</span>
<span class="sd">        :param resource_uuid: resource identifier</span>
<span class="sd">        :param user_uuid: user identifier of asserting user; omit to use current user. </span>
<span class="sd">        :return: str: resource identifier used</span>

<span class="sd">        This routine creates or changes resource parameters.</span>

<span class="sd">        This is subject to several access control rules: </span>

<span class="sd">        1. If resource_uuid is not None, it takes this parameter as the uuid of the resource.</span>

<span class="sd">        2. If resource_uuid is None, it first tries to locate the path in the resources table.</span>
<span class="sd">           Notwithstanding that, it creates a new resource uuid.</span>

<span class="sd">        Then it creates or updates a record and returns the resource uuid</span>

<span class="sd">        Regular users can: </span>

<span class="sd">        1. Create a new resource. </span>

<span class="sd">        2. Edit the title only of an existing resource. </span>
<span class="sd">        </span>
<span class="sd">        Administrative users can: </span>

<span class="sd">        1. Act as proxy for other users. </span>

<span class="sd">        2. Edit any part of the resource registration. </span>

<span class="sd">        If user_uuid is not None, then the operation is done on behalf of the stated user</span>
<span class="sd">        as an administrator. If admin privileges are not present in this case, </span>
<span class="sd">        an exception is raised. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Asserting uuid &#39;&quot;</span> <span class="o">+</span> <span class="n">user_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>
        <span class="n">requesting_user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>

        <span class="c"># check for admin privilege or user match</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Asserting login &#39;&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_irods_user</span><span class="o">+</span><span class="s">&quot;&#39; does not have admin privilege&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">resource_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># try the other keys to see if it is defined</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resource_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resource_uuid_from_path</span><span class="p">(</span><span class="n">resource_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">HSAException</span><span class="p">:</span>
                <span class="n">resource_uuid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="c"># print &quot;resource uuid is&quot;, resource_uuid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_exists</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_is_immutable</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;permission denied: resource is marked as immutable&quot;</span><span class="p">)</span>
            <span class="c"># only admin users or owners can change the resource name</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_is_owned</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_assert_resource_update</span><span class="p">(</span><span class="n">requesting_user_id</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span>
                                             <span class="n">resource_path</span><span class="p">,</span> <span class="n">resource_title</span><span class="p">,</span> <span class="n">resource_immutable</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Insufficient privileges to modify resource: must be owner or admin&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># NEW RESOURCE</span>
            <span class="c"># 1) put the resource into the registry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assert_resource_add</span><span class="p">(</span><span class="n">requesting_user_id</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span>
                                      <span class="n">resource_path</span><span class="p">,</span> <span class="n">resource_title</span><span class="p">,</span> <span class="n">resource_immutable</span><span class="p">)</span>
            <span class="c"># 2) make it owned by the asserting user</span>
            <span class="c"># get the newly minted resource id</span>
            <span class="n">resource_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resource_id_from_uuid</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">)</span>
            <span class="n">privilege_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_privilege_id_from_code</span><span class="p">(</span><span class="s">&#39;own&#39;</span><span class="p">)</span>
            <span class="c"># This bypasses checks because this user created the resource.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_share_resource_user_add</span><span class="p">(</span><span class="n">requesting_user_id</span><span class="p">,</span> <span class="n">requesting_user_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">)</span>
            <span class="c"># add owner logic here</span>
        <span class="k">return</span> <span class="n">resource_uuid</span>

    <span class="c"># subfunction: add a resource whose uuid (primary key) does not exist</span>
    <span class="c"># this has no inherent protection and is used internally for some</span>
    <span class="c"># initial creation tasks.</span></div>
    <span class="k">def</span> <span class="nf">_assert_resource_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requesting_user_id</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span>
                             <span class="n">resource_path</span><span class="p">,</span> <span class="n">resource_title</span><span class="p">,</span> <span class="n">resource_immutable</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: add a new resource to the registry</span>

<span class="sd">        :param requesting_user_id: user id of adding person</span>
<span class="sd">        :param resource_uuid: resource identifier</span>
<span class="sd">        :param resource_path: path in iRODS</span>
<span class="sd">        :param resource_title: human-readable title</span>
<span class="sd">        :param resource_immutable: whether resource is immutable</span>
<span class="sd">        :return:</span>

<span class="sd">        This adds a new and previously non-existent resource to the resource registry. resource_uuid and </span>
<span class="sd">        resource_path must be unique. If these are not unique, an exception is raised. </span>

<span class="sd">        Note: this routine is not subject to access control restrictions. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;insert into resources values (DEFAULT, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, DEFAULT)&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">resource_uuid</span><span class="p">,</span> <span class="n">resource_path</span><span class="p">,</span> <span class="n">resource_title</span><span class="p">,</span> <span class="n">resource_immutable</span><span class="p">,</span> <span class="n">requesting_user_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c"># subfunction: update a resource whose uuid is known</span>
    <span class="k">def</span> <span class="nf">_assert_resource_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requesting_user_id</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span>
                                <span class="n">resource_path</span><span class="p">,</span> <span class="n">resource_title</span><span class="p">,</span> <span class="n">resource_immutable</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: add a new resource to the registry</span>

<span class="sd">        :type requesting_user_id: int</span>
<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :type resource_path: str</span>
<span class="sd">        :type resource_title: str</span>
<span class="sd">        :type resource_immutable: bool</span>
<span class="sd">        :param requesting_user_id: user id of adding person</span>
<span class="sd">        :param resource_uuid: resource identifier</span>
<span class="sd">        :param resource_path: path in iRODS</span>
<span class="sd">        :param resource_title: human-readable title</span>
<span class="sd">        :param resource_immutable: whether resource is immutable</span>
<span class="sd">        :return:</span>

<span class="sd">        This updates an existing resource to the resource registry. resource_uuid and </span>
<span class="sd">        resource_path must be unique and a record for resource_uuid must be present. </span>
<span class="sd">        If these requirements are not met, an exception is raised. </span>

<span class="sd">        Note: this routine is not subject to access control restrictions. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;update resources set resource_path=</span><span class="si">%s</span><span class="s">, resource_title=</span><span class="si">%s</span><span class="s">, resource_immutable=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                         assertion_user_id=</span><span class="si">%s</span><span class="s">, assertion_time=CURRENT_TIMESTAMP</span>
<span class="s">                         where resource_uuid=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">resource_path</span><span class="p">,</span> <span class="n">resource_title</span><span class="p">,</span> <span class="n">resource_immutable</span><span class="p">,</span> <span class="n">requesting_user_id</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c">###########################################################</span>
    <span class="c"># user privilege over resources</span>
    <span class="c">###########################################################</span>
    <span class="k">def</span> <span class="nf">_get_privilege_id_from_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: translate from privilege code to database id</span>

<span class="sd">        :type code: str: </span>
<span class="sd">        :param code: str: code for privilege level: own, rw, ro, ns</span>
<span class="sd">        :return: int: privilege_id in database system</span>

<span class="sd">        This routine translates a privilege code into an integer. Current privilege codes include: </span>

<span class="sd">            own</span>
<span class="sd">                owner of resource (1) </span>

<span class="sd">            rw</span>
<span class="sd">                read-write (with sharing privilege) (2)</span>

<span class="sd">            ro </span>
<span class="sd">                read-only (with sharing privilege) (3) </span>

<span class="sd">            ns</span>
<span class="sd">                read-only without privilege to share. (4)</span>

<span class="sd">        The privilege level for an object is a minimum of all the privilege levels assigned by different people.</span>

<span class="sd">        For example, if </span>

<span class="sd">        * one owner assigns ownership privilege and, unbeknownst to this owner, </span>

<span class="sd">        * another owner assigns read-only privilege, </span>

<span class="sd">        Then the resulting privilege is &quot;owner&quot;. </span>

<span class="sd">        Note that although these codes are used consistently for privileges over groups and resources, </span>
<span class="sd">        there is no reasonable meaning for </span>

<span class="sd">        1. group ownership of a resource</span>

<span class="sd">        2. no sharing for a group </span>

<span class="sd">        Thus, one may not assert these states. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select privilege_id from privileges where privilege_code=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">code</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific privilege code&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;privilege_id&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Privilege code &#39;&quot;</span> <span class="o">+</span> <span class="n">code</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>

    <span class="c"># utilize a join view to summarize user privilege over a resource</span>
    <span class="c"># this utilizes the immutable flag and does not even allow the owner to</span>
    <span class="c"># redefine immutability. Only an admin can do that.</span>
<div class="viewcode-block" id="HSAccess.get_user_privilege_over_resource"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_user_privilege_over_resource">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_privilege_over_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summarize privileges of a user over a resource</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param resource_uuid: uuid of resource</span>
<span class="sd">        :param user_uuid: uuid of user; omit to report on current user </span>
<span class="sd">        :return: int: privilege number 1-100</span>

<span class="sd">        The access privileges are the minimum (most powerful) privilege granted by any one user. </span>
<span class="sd">        These include: </span>

<span class="sd">        1. Privileges granted specifically to the user. </span>

<span class="sd">        2. Privileges granted via membership in a group. </span>

<span class="sd">        Note: this routine is not subject to access control. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="n">resource_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resource_id_from_uuid</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">)</span>
        <span class="c"># user_resource_privilege is a UNION of user and group privileges and contains duplicates</span>
        <span class="c"># collapse the duplicates with a MIN function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select min(privilege_id) as privilege_id from user_resource_privilege</span>
<span class="s">                          where user_id=</span><span class="si">%s</span><span class="s"> and resource_id=</span><span class="si">%s</span><span class="s"></span>
<span class="s">                          group by user_id, resource_id&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific user/resource pair&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># print self._cur.fetchone()</span>
            <span class="n">priv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;privilege_id&#39;</span><span class="p">]</span>

            <span class="c"># GROUP BY makes this unnecessary</span>
            <span class="c"># if priv is None:</span>
            <span class="c">#     priv = self._PRIVILEGE_NONE</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_is_immutable</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PRIVILEGE_RO</span><span class="p">)</span>  <span class="c"># eliminate write privileges from base privilege word.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">priv</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># print &quot;no privilege&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PRIVILEGE_NONE</span>  <span class="c"># no privilege</span>
</div>
<div class="viewcode-block" id="HSAccess.resource_accessible"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.resource_accessible">[docs]</a>    <span class="k">def</span> <span class="nf">resource_accessible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if resource is accessible to a specific user in a specific way</span>

<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :type code: str</span>
<span class="sd">        :param user_uuid: user uuid, key to users table</span>
<span class="sd">        :param resource_uuid: resource uuid: key to resources table</span>
<span class="sd">        :param code: privilege code: key to privileges table</span>
<span class="sd">        :return: bool: True if resource is accessible to user in the mode indicated by code</span>

<span class="sd">        This routine checks if a resource is accessible at a given level. </span>
<span class="sd">        The codes include:</span>

<span class="sd">            own</span>
<span class="sd">                ownership</span>

<span class="sd">            rw </span>
<span class="sd">                read-write (with sharing) </span>

<span class="sd">            ro </span>
<span class="sd">                read-only (with sharing) </span>

<span class="sd">            ns </span>
<span class="sd">                read-only (no sharing) </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># OBSOLETE: user_id = self._get_user_id_from_login(login)</span>
        <span class="c"># OBSOLETE: resource_id = self._get_resource_id_from_uuid(uuid)</span>
        <span class="n">privilege_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_privilege_id_from_code</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">actual_priv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_privilege_over_resource</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">)</span>
        <span class="c"># print &quot;desired privilege&quot;, privilege_id, &quot;actual privilege&quot;, actual_priv</span>
        <span class="k">if</span> <span class="n">actual_priv</span> <span class="o">&lt;=</span> <span class="n">privilege_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="HSAccess.resource_is_owned"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.resource_is_owned">[docs]</a>    <span class="k">def</span> <span class="nf">resource_is_owned</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether a given resource is owned by a specific user</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param resource_uuid: resource identifier for resource to be checked for access</span>
<span class="sd">        :param user_uuid: uuid of user whose privileges should be checked; omit to check current user </span>
<span class="sd">        :return: bool: True if user owns resource. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_accessible</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="s">&#39;own&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HSAccess.resource_is_readwrite"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.resource_is_readwrite">[docs]</a>    <span class="k">def</span> <span class="nf">resource_is_readwrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether a given resource is read/write to a specific user</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param resource_uuid: resource identifier for resource to be checked for access</span>
<span class="sd">        :param user_uuid: uuid of user whose privileges should be checked; omit to check current user </span>
<span class="sd">        :return: bool: True if user has readwrite privilege over resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_accessible</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="s">&#39;rw&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HSAccess.resource_is_readable"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.resource_is_readable">[docs]</a>    <span class="k">def</span> <span class="nf">resource_is_readable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether a given resource is readable by a specific user</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param resource_uuid: resource identifier for resource to be checked for access</span>
<span class="sd">        :param user_uuid: uuid of user whose privileges should be checked; omit to check current user </span>
<span class="sd">        :return: bool: True if user has read-only privilege over resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_accessible</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="s">&#39;ro&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HSAccess.resource_is_readable_without_sharing"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.resource_is_readable_without_sharing">[docs]</a>    <span class="k">def</span> <span class="nf">resource_is_readable_without_sharing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether a given resource is readable without sharing</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param resource_uuid: resource identifier for resource to be checked for access</span>
<span class="sd">        :param user_uuid: uuid of user whose privileges should be checked; omit to check current user </span>
<span class="sd">        :return: bool: True if user has read-only without sharing privileges over resource. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_accessible</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="s">&#39;ns&#39;</span><span class="p">)</span>

    <span class="c">###########################################################</span>
    <span class="c"># Share a resource with a specific user.</span>
    <span class="c"># CLI: hs_share_resource</span>
    <span class="c"># business logic:</span>
    <span class="c"># we can share a resource with a user</span>
    <span class="c"># - at a privilege that we already enjoy for the resource.</span>
    <span class="c"># - unless your privilege is &quot;ns&quot;.</span>
    <span class="c"># - or you have admin privileges.</span>
    <span class="c"># users who shared a resource with another user can downgrade or upgrade that sharing as desired.</span>
    <span class="c"># The sharing privileges for a user are a logical OR of all granted sharing privileges from all sources</span>
    <span class="c">###########################################################</span>
</div>
<div class="viewcode-block" id="HSAccess.share_resource_with_user"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.share_resource_with_user">[docs]</a>    <span class="k">def</span> <span class="nf">share_resource_with_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">,</span> <span class="n">privilege_code</span><span class="o">=</span><span class="s">&#39;ns&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Share a specific resource with a specific user</span>

<span class="sd">        :param resource_uuid: str: uuid of resource to affect (key to resource table)</span>
<span class="sd">        :param user_uuid: str: login name of user to gain access (key to users table)</span>
<span class="sd">        :param privilege_code: str: privilege to grant (key to privileges table)</span>
<span class="sd">        :return:</span>

<span class="sd">        This shares a resource with a user other than self. The current user is implicitly </span>
<span class="sd">        the initiator of the sharing. </span>

<span class="sd">        This is subject to several restrictions: </span>

<span class="sd">        1. A user may not share a resource with self. </span>

<span class="sd">        2. A user may not share a resource at a higher privilege level than that held by the user. </span>

<span class="sd">        3. A user may only update records created by that user, e.g., to upgrade or downgrade sharing</span>
<span class="sd">           privileges for another user. </span>

<span class="sd">        4. An administrative user may arbitrarily change sharing parameters. </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="n">privilege_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_privilege_id_from_code</span><span class="p">(</span><span class="n">privilege_code</span><span class="p">)</span>
        <span class="n">resource_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resource_id_from_uuid</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">)</span>
        <span class="n">requesting_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)</span>
        <span class="c"># access control logic: cannot grant sharing above own privilege</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)):</span>
            <span class="c"># use join to access privilege records</span>
            <span class="n">user_priv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_privilege_over_resource</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user_priv</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PRIVILEGE_NS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Cannot share a resource to which one has no sharing privileges&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">user_priv</span> <span class="o">&gt;</span> <span class="n">privilege_id</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;User has insufficient privilege to share this resource at this level&quot;</span><span class="p">)</span>
        <span class="c"># sufficient privileges present to share this resource</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_access_to_resource_exists</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">):</span>
            <span class="c"># don&#39;t let user remove last owner.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_of_resource_owners</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> \
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_privilege_over_resource</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_share_resource_user_update</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;cannot remove last resource owner, including self&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_share_resource_user_add</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_user_access_to_resource_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">asserting_user_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: Determine whether there is a record currently sharing the resource, by this user</span>

<span class="sd">        :type user_id: int </span>
<span class="sd">        :type resource_id: int</span>
<span class="sd">        :type asserting_user_id</span>
<span class="sd">        :param user_id: id of user to gain privilege</span>
<span class="sd">        :param resource_id: id of resource on which to grant privilege</span>
<span class="sd">        :param asserting_user_id: id of user granting privilege</span>
<span class="sd">        :return: bool: True if there is a current record for this triple</span>

<span class="sd">        This is a helper routine for &quot;share_resource_with_user&quot;.</span>
<span class="sd">        Note: this routine is not subject to access control.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;select privilege_id from user_access_to_resource where user_id=%s</span>
<span class="sd">            and resource_id=%s and assertion_user_id=%s&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">asserting_user_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a specific privilege code&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_share_resource_user_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: update a user record</span>

<span class="sd">        :type requesting_id: int</span>
<span class="sd">        :type user_id: int</span>
<span class="sd">        :type resource_id: int</span>
<span class="sd">        :type privilege_id: int</span>
<span class="sd">        :param requesting_id: user id of requesting user</span>
<span class="sd">        :param user_id: user id of affected user</span>
<span class="sd">        :param resource_id: resource id of affected resource</span>
<span class="sd">        :param privilege_id: privilege id to assign</span>
<span class="sd">        :return:</span>

<span class="sd">        This is a helper routine for &quot;share_resource_with_user&quot;. If the resource record </span>
<span class="sd">        to be updated does not exist, an exception is raised. </span>
<span class="sd">         </span>
<span class="sd">        Note: this routine is not subject to access control.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;update user_access_to_resource set privilege_id = </span><span class="si">%s</span><span class="s">,</span>
<span class="s">          assertion_time=CURRENT_TIMESTAMP where user_id=</span><span class="si">%s</span><span class="s"> and resource_id=</span><span class="si">%s</span><span class="s"> and assertion_user_id=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">privilege_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_share_resource_user_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: add a user record</span>

<span class="sd">        :type requesting_id: int</span>
<span class="sd">        :type user_id: int</span>
<span class="sd">        :type resource_id: int</span>
<span class="sd">        :type privilege_id: int</span>
<span class="sd">        :param requesting_id: user id of requesting user</span>
<span class="sd">        :param user_id: user id of affected user</span>
<span class="sd">        :param resource_id: resource id of affected resource</span>
<span class="sd">        :param privilege_id: privilege id to assign</span>
<span class="sd">        :return:</span>

<span class="sd">        This is a helper routine for &#39;share_resource_with_user&#39;. If the resource record </span>
<span class="sd">        to be updated does not exist, an exception is raised. </span>
<span class="sd">         </span>
<span class="sd">        Note: this routine is not subject to access control.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;insert into user_access_to_resource values (DEFAULT, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, DEFAULT)&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<div class="viewcode-block" id="HSAccess.unshare_resource_with_user"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.unshare_resource_with_user">[docs]</a>    <span class="k">def</span> <span class="nf">unshare_resource_with_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">resource_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove all sharing with user (owner only)</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :type user_uuid: str </span>
<span class="sd">        :param resource_uuid: resource to change</span>
<span class="sd">        :param user_uuid: user with whom resource is currently shared; omit for current user </span>
<span class="sd">        :return:</span>

<span class="sd">        Note: since sharing is cumulative, each user sharing a document with another must separately retract sharing</span>
<span class="sd">        before all sharing is removed. It is possible that a user will have several different paths to a resource.</span>

<span class="sd">        This routine unshares a resource under three possible conditions; either:</span>
<span class="sd">        1. user is admin, or </span>

<span class="sd">        2. user owns resource, or </span>

<span class="sd">        3. user is the sharing target: one should be able to &quot;forget&quot; a share if necessary</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="c"># assert_id = self._get_user_id_from_uuid(self._user_uuid)</span>
        <span class="n">resource_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resource_id_from_uuid</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)</span> \
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_is_owned</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">)</span> \
                <span class="ow">or</span> <span class="n">user_uuid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_of_resource_owners</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> \
                    <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_is_owned</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;delete from user_access_to_resource where user_id = </span><span class="si">%s</span><span class="s"> and resource_id = </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
                                  <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;cannot remove last owner of a resource&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;insufficient privilege to unshare resource with user&quot;</span><span class="p">)</span>

    <span class="c">###########################################################</span>
    <span class="c"># group privilege</span>
    <span class="c">###########################################################</span>

    <span class="c"># ##########################################################</span>
    <span class="c"># share a resource with a group of users</span>
    <span class="c"># CLI: hs_share_resource</span>
    <span class="c"># business logic:</span>
    <span class="c"># you can share a resource with a group if</span>
    <span class="c"># - you are in the group and</span>
    <span class="c"># - you have sharing privilege over the resource equal or greater than what you wish to assign or</span>
    <span class="c"># - you are an administrator</span>
    <span class="c"># ##########################################################</span>
</div>
<div class="viewcode-block" id="HSAccess.share_resource_with_group"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.share_resource_with_group">[docs]</a>    <span class="k">def</span> <span class="nf">share_resource_with_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">privilege_code</span><span class="o">=</span><span class="s">&#39;ns&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Share a resource with a group of users</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :type privilege_code: str</span>
<span class="sd">        :param resource_uuid: the resource to be shared</span>
<span class="sd">        :param group_uuid: the group with which to share it: self._user_uuid must be a member.</span>
<span class="sd">        :param privilege_code: the privilege to assign: must be less than or equal to self._user_uuid&#39;s privilege</span>
<span class="sd">        :return:</span>

<span class="sd">        Share a resource with a group as the current user. </span>

<span class="sd">        Preconditions:</span>

<span class="sd">        1. Current user must be a member of the group, or have administrative privilege. </span>

<span class="sd">        2. Current user must have the same or more comprehensive access to the resource than for the share, </span>
<span class="sd">           or administrative privilege. </span>

<span class="sd">        Postconditions: resource is shared with all members of the group. Privileges changes for all group members</span>
<span class="sd">        as individuals, simultaneously. </span>

<span class="sd">        This works the same whether this is the first or a subsequent time the resource is shared. A user can </span>
<span class="sd">        downgrade or upgrade sharing privileges for a resource at will. </span>

<span class="sd">        Note: if a user shares a privilege that is then revoked for that user, the sharing privilege persists </span>
<span class="sd">        for the object.  It is possible to downgrade privilege assigned by a user whose privilege has been </span>
<span class="sd">        downgraded, but this has not been implemented. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_id_from_uuid</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
        <span class="n">privilege_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_privilege_id_from_code</span><span class="p">(</span><span class="n">privilege_code</span><span class="p">)</span>
        <span class="n">resource_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resource_id_from_uuid</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">)</span>
        <span class="n">requesting_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)</span>
        <span class="c"># access control logic: cannot grant sharing above own privilege</span>
        <span class="k">if</span> <span class="n">privilege_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PRIVILEGE_OWN</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Cannot assert &#39;ownership&#39; privilege for a group&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_in_group</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;User must be a member of a group to share something with the group&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)):</span>
                <span class="c"># use join to access privilege records</span>
                <span class="n">user_priv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_privilege_over_resource</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">user_priv</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PRIVILEGE_NS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Cannot share a group for which user has no sharing privileges&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">user_priv</span> <span class="o">&gt;</span> <span class="n">privilege_id</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;User has insufficient privilege to share this resource at this level&quot;</span><span class="p">)</span>
        <span class="c"># sufficient privileges present to share this resource</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_access_to_resource_exists</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span>  <span class="n">resource_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_share_resource_group_update</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_share_resource_group_add</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_group_access_to_resource_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: Check whether there is already a privilege record for asserting user, group, and resource</span>

<span class="sd">        :type group_id: int</span>
<span class="sd">        :type resource_id: int</span>
<span class="sd">        :type requesting_id: int</span>
<span class="sd">        :param group_id: internal group id of affected group</span>
<span class="sd">        :param resource_id: internal resource id of affected resource</span>
<span class="sd">        :param requesting_id: internal id of user requesting change</span>
<span class="sd">        :return:</span>

<span class="sd">        This is a helper routine for &#39;share_resource_with_group&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;select privilege_id from group_access_to_resource where group_id=%s</span>
<span class="sd">            and resource_id=%s and assertion_user_id=%s&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for &quot;</span>
                               <span class="o">+</span> <span class="s">&quot;specific group, resource, and user&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_share_resource_group_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: update group sharing record for a resource</span>

<span class="sd">        :type requesting_id: int</span>
<span class="sd">        :type group_id: int</span>
<span class="sd">        :type resource_id: int</span>
<span class="sd">        :type privilege_id: int</span>
<span class="sd">        :param requesting_id: id of requesting user</span>
<span class="sd">        :param group_id: id of group to modify</span>
<span class="sd">        :param resource_id: id of resource to modify</span>
<span class="sd">        :param privilege_id: privilege to assign</span>
<span class="sd">        :return:</span>

<span class="sd">        This is a helper routine for &#39;share_resource_with_group&#39;.</span>

<span class="sd">        The group sharing record must exist or an exception is raised. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;update group_access_to_resource set privilege_id = </span><span class="si">%s</span><span class="s">,</span>
<span class="s">                          assertion_time=CURRENT_TIMESTAMP where group_id=</span><span class="si">%s</span><span class="s"></span>
<span class="s">                          and resource_id=</span><span class="si">%s</span><span class="s"> and assertion_user_id=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">privilege_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_share_resource_group_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: add a new group sharing record for a resource</span>

<span class="sd">        :type requesting_id: int</span>
<span class="sd">        :type group_id: int</span>
<span class="sd">        :type resource_id: int</span>
<span class="sd">        :type privilege_id: int</span>
<span class="sd">        :param requesting_id: id of requesting user</span>
<span class="sd">        :param group_id: id of group to modify</span>
<span class="sd">        :param resource_id: id of resource to modify</span>
<span class="sd">        :param privilege_id: privilege to assign</span>
<span class="sd">        :return:</span>

<span class="sd">        This is a helper routine for &#39;share_resource_with_group&#39;.</span>

<span class="sd">        The group sharing record must not exist or an exception is raised. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;insert into group_access_to_resource values (DEFAULT, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, DEFAULT)&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<div class="viewcode-block" id="HSAccess.unshare_resource_with_group"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.unshare_resource_with_group">[docs]</a>    <span class="k">def</span> <span class="nf">unshare_resource_with_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove all sharing with user (owner or administrator only)</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :param resource_uuid: resource to change</span>
<span class="sd">        :param group_uuid: group with whom resource is currently potentially shared</span>
<span class="sd">        :return:</span>

<span class="sd">        Only a group owner or administrator may revoke all privileges over a resource.  This </span>
<span class="sd">        includes all grants of privilege no matter what the source within the group. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># assert_id = self._get_user_id_from_uuid(self._user_uuid)</span>
        <span class="n">resource_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resource_id_from_uuid</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">)</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_id_from_uuid</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_is_owned</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;delete from group_access_to_resource where group_id = </span><span class="si">%s</span><span class="s"> and resource_id=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
                              <span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;insufficient privilege to unshare resource with group: must be owner or admin&quot;</span><span class="p">)</span>

    <span class="c">###########################################################</span>
    <span class="c"># group membership</span>
    <span class="c">###########################################################</span>
    <span class="c"># refactored to remove duplication between group privilege and membership</span></div>
<div class="viewcode-block" id="HSAccess.user_in_group"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.user_in_group">[docs]</a>    <span class="k">def</span> <span class="nf">user_in_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether a user is a member of a group</span>

<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :param user_uuid: uuid of a valid user, omit to check current user </span>
<span class="sd">        :param group_uuid: group uuid of a valid group</span>
<span class="sd">        :return: bool: True if the uuid is in the group</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_id_from_uuid</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select privilege_id from user_group_privilege where user_id=</span><span class="si">%s</span><span class="s"> and group_id=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one group membership record &quot;</span>
                               <span class="o">+</span> <span class="s">&quot;for a user and group&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="c"># # OLD VERSION with specific user_membership_in_group table</span>
    <span class="c"># # REPLACED with conflation of privilege with membership</span>
    <span class="c"># # to avoid potential data skwews</span>
    <span class="c"># def user_in_group(self, group_uuid, user_uuid=None):</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     Check whether a user is a member of a group</span>
    <span class="c">#</span>
    <span class="c">#     :type user_uuid: str</span>
    <span class="c">#     :type group_uuid: str</span>
    <span class="c">#     :param user_uuid: uuid of a valid user</span>
    <span class="c">#     :param group_uuid: group uuid of a valid group</span>
    <span class="c">#     :return: True if the uuid is in the group</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     if user_uuid is None:</span>
    <span class="c">#         user_uuid = self._user_uuid</span>
    <span class="c">#     user_id = self._get_user_id_from_uuid(user_uuid)</span>
    <span class="c">#     group_id = self._get_group_id_from_uuid(group_uuid)</span>
    <span class="c">#     self._cur.execute(&quot;&quot;&quot;select id from user_membership_in_group where user_id=%s and group_id=%s&quot;&quot;&quot;,</span>
    <span class="c">#                       (user_id, group_id))</span>
    <span class="c">#     if self._cur.rowcount &gt; 1:</span>
    <span class="c">#         raise HSAException(&quot;Database integrity violation: more than one group membership record &quot;</span>
    <span class="c">#                            + &quot;for a user and group&quot;)</span>
    <span class="c">#     if self._cur.rowcount &gt; 0:</span>
    <span class="c">#         return True</span>
    <span class="c">#     else:</span>
    <span class="c">#         return False</span>
    <span class="c">#</span>
    <span class="c"># def assert_user_in_group(self, group_uuid, user_uuid=None):</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     Add a user to a group if not present already</span>
    <span class="c">#</span>
    <span class="c">#     :type user_uuid: str</span>
    <span class="c">#     :type group_uuid: str</span>
    <span class="c">#     :param user_uuid: user to be added to the group</span>
    <span class="c">#     :param group_uuid: group to which to add user</span>
    <span class="c">#     :return:</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     if user_uuid is None:</span>
    <span class="c">#         user_uuid = self._user_uuid</span>
    <span class="c">#     # if not self.user_is_active(self._user_uuid):</span>
    <span class="c">#     #     raise HSAException(&quot;User login &#39;&quot;+self._get_user_login_from_uuid(self._user_uuid)+&quot;&#39; is not active&quot;)</span>
    <span class="c">#     if not self.user_exists(user_uuid):</span>
    <span class="c">#         raise HSAException(&quot;User uuid &#39;&quot;+user_uuid+&quot;&#39; does not exist&quot;)</span>
    <span class="c">#     if not self.user_is_active(user_uuid):</span>
    <span class="c">#         raise HSAException(&quot;User login &#39;&quot;+self._get_user_login_from_uuid(user_uuid)+&quot;&#39; is not active&quot;)</span>
    <span class="c">#     if not self.group_is_readwrite(group_uuid, self._user_uuid):</span>
    <span class="c">#         raise HSAException(&quot;Group &#39;&quot;+self._get_group_name_from_uuid(group_uuid)</span>
    <span class="c">#                            + &quot;&#39; is not writeable to user login &#39;&quot;</span>
    <span class="c">#                            + self._get_user_login_from_uuid(self._user_uuid)+&quot;&#39;&quot;)</span>
    <span class="c">#     self._assert_user_in_group(group_uuid, user_uuid)</span>
    <span class="c">#</span>
    <span class="c"># # need this in certain system routines to avoid protection chicken-and-egg problems</span>
    <span class="c"># def _assert_user_in_group(self, group_uuid, user_uuid=None):</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     Override protection scheme to insert first user into group</span>
    <span class="c">#   </span>
    <span class="c">#     :param user_uuid:</span>
    <span class="c">#     :param group_uuid:</span>
    <span class="c">#     :return:</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     if user_uuid is None:</span>
    <span class="c">#         user_uuid = self._user_uuid</span>
    <span class="c">#     requesting_id = self._get_user_id_from_uuid(self._user_uuid)</span>
    <span class="c">#     user_id = self._get_user_id_from_uuid(user_uuid)</span>
    <span class="c">#     group_id = self._get_group_id_from_uuid(group_uuid)</span>
    <span class="c">#     if not (self.user_in_group(group_uuid, user_uuid)):</span>
    <span class="c">#         self._cur.execute(&quot;insert into user_membership_in_group VALUES (DEFAULT, %s, %s, %s, DEFAULT)&quot;,</span>
    <span class="c">#                           (user_id, group_id, requesting_id))</span>
    <span class="c">#         self._conn.commit()</span>
    <span class="c">#     # self.share_group_with_user(group_uuid, user_uuid, &#39;ro&#39;)</span>
    <span class="c">#</span>
    <span class="c"># # CLI: hs_remove_user_from_group</span>
    <span class="c"># def retract_user_from_group(self, user_uuid, group_uuid):</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     Remove a user from a group if not absent already</span>
    <span class="c">#</span>
    <span class="c">#     :type user_uuid: str</span>
    <span class="c">#     :type group_uuid: str</span>
    <span class="c">#     :param user_uuid: user to be removed from the group</span>
    <span class="c">#     :param group_uuid: group from which to remove user</span>
    <span class="c">#     :return:</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#</span>
    <span class="c">#     user_id = self._get_user_id_from_uuid(user_uuid)</span>
    <span class="c">#     group_id = self._get_group_id_from_uuid(group_uuid)</span>
    <span class="c">#</span>
    <span class="c">#     # for now, let people remove themselves</span>
    <span class="c">#     if self._user_uuid == user_uuid and self.user_in_group(group_uuid, user_uuid):</span>
    <span class="c">#         self._cur.execute(&quot;delete from user_membership_in_group where user_id=%s and group_id=%s&quot;,</span>
    <span class="c">#                           (user_id, group_id))</span>
    <span class="c">#     else:</span>
    <span class="c">#         raise HSAException(&quot;Insufficient privilege to retract user from group&quot;)</span>
    <span class="c">#     self.unshare_group_with_user(group_uuid, user_uuid)</span>

    <span class="c">###########################################################</span>
    <span class="c"># group access</span>
    <span class="c"># in current version this is synonymous with membership</span>
    <span class="c">###########################################################</span>

    <span class="c"># utilize a join view to summarize user privilege</span></div>
<div class="viewcode-block" id="HSAccess.get_user_privilege_over_group"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_user_privilege_over_group">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_privilege_over_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the privilege that is specified for a user over a specific group</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :param user_uuid: uuid of user for which to obtain privilege</span>
<span class="sd">        :param group_uuid: group to which to allow access</span>
<span class="sd">        :return: int: privilege code 1-100</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_id_from_uuid</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select privilege_id from user_group_privilege where user_id=</span><span class="si">%s</span><span class="s"> and group_id=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one protection int for a user and group&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;privilege_id&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PRIVILEGE_NONE</span>  <span class="c"># no privilege</span>

    <span class="c"># utility routine returns numeric code for privilege</span></div>
    <span class="k">def</span> <span class="nf">_group_accessible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: check whether a group is accessible to a user</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :type code: str</span>
<span class="sd">        :param user_uuid: uuid of user for whom to check privilege (key to users table)</span>
<span class="sd">        :param group_uuid: uuid of group for which to check privilege (key to groups table)</span>
<span class="sd">        :param code: privilege code (key to privileges table)</span>
<span class="sd">        :return: bool: True if group is accessible to user in the provided mode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">requested_priv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_privilege_id_from_code</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">actual_priv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_privilege_over_group</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">)</span>
        <span class="c"># print user_uuid, group_uuid, &quot;requested priv=&quot;, requested_priv, &quot;actual priv=&quot;, actual_priv</span>
        <span class="k">if</span> <span class="n">actual_priv</span> <span class="o">&lt;=</span> <span class="n">requested_priv</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="c"># can remove group and disinvite group members.</span>
<div class="viewcode-block" id="HSAccess.group_is_owned"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.group_is_owned">[docs]</a>    <span class="k">def</span> <span class="nf">group_is_owned</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether a group is owned by a user</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :param user_uuid: uuid of user to check</span>
<span class="sd">        :param group_uuid: group uuid of group to check</span>
<span class="sd">        :return: bool: True if group uuid is owned by user uuid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_accessible</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="s">&#39;own&#39;</span><span class="p">)</span>

    <span class="c"># can invite members to group</span></div>
<div class="viewcode-block" id="HSAccess.group_is_readwrite"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.group_is_readwrite">[docs]</a>    <span class="k">def</span> <span class="nf">group_is_readwrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether a group is owned by a user</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :param user_uuid: uuid of user to check</span>
<span class="sd">        :param group_uuid: group uuid of group to check</span>
<span class="sd">        :return: bool: True if group uuid is read/write to user uuid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_accessible</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="s">&#39;rw&#39;</span><span class="p">)</span>

    <span class="c"># minimal group membership: can see members but cannot add/invite them</span></div>
<div class="viewcode-block" id="HSAccess.group_is_readable"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.group_is_readable">[docs]</a>    <span class="k">def</span> <span class="nf">group_is_readable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether a group is owned by a user</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :param user_uuid: uuid of user to check</span>
<span class="sd">        :param group_uuid: group uuid of group to check</span>
<span class="sd">        :return: bool: True if group uuid is readable by user uuid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_accessible</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="s">&#39;ro&#39;</span><span class="p">)</span>

    <span class="c"># # this is a meaningless protection</span>
    <span class="c"># def group_is_readable_without_sharing(self, group_uuid, user_uuid=None):</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     Check whether a group is readable without sharing by a user</span>
    <span class="c">#     :type user_uuid: str</span>
    <span class="c">#     :type group_uuid: str</span>
    <span class="c">#     :param user_uuid: uuid of user to check</span>
    <span class="c">#     :param group_uuid: group uuid of group to check</span>
    <span class="c">#     :return: True if group uuid is readable without sharing to user uuid</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     if user_uuid is None:</span>
    <span class="c">#         user_uuid = self._user_uuid</span>
    <span class="c">#     return self._group_accessible(user_uuid, group_uuid, &#39;ns&#39;)</span>

    <span class="c"># CLI: hs invite ....</span></div>
<div class="viewcode-block" id="HSAccess.invite_user_to_group"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.invite_user_to_group">[docs]</a>    <span class="k">def</span> <span class="nf">invite_user_to_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">,</span> <span class="n">privilege_code</span><span class="o">=</span><span class="s">&#39;ro&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invite a user into a group. The user must accept in a separate step</span>
<span class="sd">        :param group_uuid:</span>
<span class="sd">        :param user_uuid:</span>
<span class="sd">        :param privilege_code:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="n">privilege_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_privilege_id_from_code</span><span class="p">(</span><span class="n">privilege_code</span><span class="p">)</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_id_from_uuid</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
        <span class="n">requesting_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)</span>
        <span class="c"># sanity logic: no such thing as &#39;ns&#39; access.</span>
        <span class="k">if</span> <span class="n">privilege_code</span> <span class="o">==</span> <span class="s">&#39;ns&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;privilege &#39;readable without sharing&#39; does not apply to groups&quot;</span><span class="p">)</span>
        <span class="c"># access control logic: cannot grant sharing above own privilege</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)):</span>
            <span class="c"># use join to access privilege records</span>
            <span class="n">user_priv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_privilege_over_group</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user_priv</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PRIVILEGE_RO</span><span class="p">:</span>  <span class="c"># read-only or no-sharing</span>
                <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;user lacks read/write privilege necessary to invite to this group&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">user_priv</span> <span class="o">&gt;</span> <span class="n">privilege_id</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;user must hold a privilege in order to share it&quot;</span><span class="p">)</span>
        <span class="c"># sufficient privileges present to share this resource</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_invite_to_group_exists</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_invite_group_user_update</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_invite_group_user_add</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_invite_group_user_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: update user access to a group</span>
<span class="sd">        :type requesting_id: int</span>
<span class="sd">        :type user_id: int</span>
<span class="sd">        :type group_id: int</span>
<span class="sd">        :type privilege_id: int</span>
<span class="sd">        :param requesting_id: id of user requesting change</span>
<span class="sd">        :param user_id: id of user to be enabled</span>
<span class="sd">        :param group_id: id of group to be modified</span>
<span class="sd">        :param privilege_id: id of privilege to be installed</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;update user_invitations_to_group set privilege_id = </span><span class="si">%s</span><span class="s">,</span>
<span class="s">                          assertion_time=CURRENT_TIMESTAMP where user_id=</span><span class="si">%s</span><span class="s"> and group_id=</span><span class="si">%s</span><span class="s"> and assertion_user_id=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">privilege_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_invite_group_user_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: add new user access for a group</span>
<span class="sd">        :type requesting_id: int</span>
<span class="sd">        :type user_id: int</span>
<span class="sd">        :type group_id: int</span>
<span class="sd">        :type privilege_id: int</span>
<span class="sd">        :param requesting_id: int: id of user requesting change</span>
<span class="sd">        :param user_id: int: id of user to be enabled</span>
<span class="sd">        :param group_id: int: id of group to be modified</span>
<span class="sd">        :param privilege_id: int: id of privilege to be installed</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;insert into user_invitations_to_group values (DEFAULT, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, DEFAULT)&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c"># determine whether an invitation exists already</span>
    <span class="k">def</span> <span class="nf">_user_invite_to_group_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test whether there is an access record for a specific user, group, and asserting user</span>
<span class="sd">        :type user_id: int</span>
<span class="sd">        :type group_id: int</span>
<span class="sd">        :type requesting_id: int</span>
<span class="sd">        :param user_id: user id of user who needs privilege</span>
<span class="sd">        :param group_id: group id of group to which privilege will be assigned</span>
<span class="sd">        :param requesting_id: user id of user assigning privilege</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;select privilege_id from user_invitations_to_group where user_id=%s and group_id=%s</span>
<span class="sd">            and assertion_user_id=%s&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a group privilege triple&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_get_privilege_from_group_invite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test whether there is an access record for a specific user, group, and asserting user</span>
<span class="sd">        :type user_id: int</span>
<span class="sd">        :type group_id: int</span>
<span class="sd">        :type requesting_id: int</span>
<span class="sd">        :param user_id: user id of user who needs privilege</span>
<span class="sd">        :param group_id: group id of group to which privilege will be assigned</span>
<span class="sd">        :param requesting_id: user id of user assigning privilege</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;select privilege_id from user_invitations_to_group where user_id=%s and group_id=%s</span>
<span class="sd">            and assertion_user_id=%s&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a group privilege triple&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;privilege_id&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;no existing group invitation&quot;</span><span class="p">)</span>

    <span class="c"># a user can only revoke one&#39;s own invitations</span>
    <span class="c"># CLI: hs uninvite ....</span>
<div class="viewcode-block" id="HSAccess.uninvite_user_to_group"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.uninvite_user_to_group">[docs]</a>    <span class="k">def</span> <span class="nf">uninvite_user_to_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uninvite a user the current user invited; does not undo other invitations</span>
<span class="sd">        Revoke an invitation to join a group</span>
<span class="sd">        :param group_uuid: uuid of group</span>
<span class="sd">        :param user_uuid: uuid of user</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_id_from_uuid</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
        <span class="n">requesting_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uninvite_user_to_group</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_uninvite_user_to_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_invite_to_group_exists</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;delete from user_invitations_to_group where user_id=</span><span class="si">%s</span><span class="s"></span>
<span class="s">                              and group_id=</span><span class="si">%s</span><span class="s"> and assertion_user_id=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
                              <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c"># CLI hs ls invitations</span>
<div class="viewcode-block" id="HSAccess.get_group_invitations_for_user"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_group_invitations_for_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_group_invitations_for_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of invitations to join groups that can be accepted or refused</span>

<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param user_uuid: uuid of user; omit for current user. </span>
<span class="sd">        :return:</span>

<span class="sd">        List group invitations in the form::</span>

<span class="sd">            {&#39;group&#39;: </span>
<span class="sd">                {&#39;uuid&#39;: {uuid of group},</span>
<span class="sd">                 &#39;name&#39;: {name of group},</span>
<span class="sd">                 &#39;privilege&#39;: {privilege_code}},</span>
<span class="sd">             &#39;host&#39;: </span>
<span class="sd">                { &#39;uuid&#39;: {uuid of inviting user},</span>
<span class="sd">                  &#39;name&#39;: {name of inviting user},</span>
<span class="sd">                  &#39;login&#39;: {login of inviting user}}</span>
<span class="sd">            }</span>

<span class="sd">        Note: this is scheduled for refactoring for easier acceptance, rejection, and uninviting of users</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select g.group_uuid, g.group_name, p.privilege_code, a.user_uuid, a.user_name, a.user_login</span>
<span class="s">                          from user_invitations_to_group i</span>
<span class="s">                          left join groups g on i.group_id=g.group_id</span>
<span class="s">                          left join users u on u.user_id = i.user_id</span>
<span class="s">                          left join users a on a.user_id = i.assertion_user_id</span>
<span class="s">                          left join privileges p on p.privilege_id=i.privilege_id</span>
<span class="s">                          where u.user_uuid=</span><span class="si">%s</span><span class="s"></span>
<span class="s">                          order by i.assertion_time desc&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">user_uuid</span><span class="p">,))</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="p">[{</span><span class="s">&#39;group&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;group_uuid&#39;</span><span class="p">],</span>
                                  <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;group_name&#39;</span><span class="p">],</span>
                                  <span class="s">&#39;privilege&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;privilege_code&#39;</span><span class="p">]},</span>
                        <span class="s">&#39;host&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_uuid&#39;</span><span class="p">],</span>
                                  <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_name&#39;</span><span class="p">],</span>
                                  <span class="s">&#39;login&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;user_login&#39;</span><span class="p">]}}]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c"># CLI: hs accept ...</span></div>
<div class="viewcode-block" id="HSAccess.accept_invitation_to_group"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.accept_invitation_to_group">[docs]</a>    <span class="k">def</span> <span class="nf">accept_invitation_to_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">host_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Accept an invitation to join a group</span>

<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :type host_uuid: str</span>
<span class="sd">        :param group_uuid: uuid of group for which to accept invitation</span>
<span class="sd">        :param host_uuid: user uuid of person who invited you</span>
<span class="sd">        :return:</span>

<span class="sd">        Accept an invitation to a group previously made by another user via </span>
<span class="sd">        &#39;invite_user_to_group&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_id_from_uuid</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
        <span class="n">requesting_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">host_uuid</span><span class="p">)</span>
        <span class="n">privilege_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_privilege_from_group_invite</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_invite_to_group_exists</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_share_group_with_user</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">)</span>
            <span class="c"># remove invitation after acting on it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_uninvite_user_to_group</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;no group invitation exists for user&quot;</span><span class="p">)</span>

    <span class="c"># CLI: hs refuse</span></div>
<div class="viewcode-block" id="HSAccess.refuse_invitation_to_group"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.refuse_invitation_to_group">[docs]</a>    <span class="k">def</span> <span class="nf">refuse_invitation_to_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">host_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refuse an invitation to join a group</span>

<span class="sd">        :param group_uuid:</span>
<span class="sd">        :param host_uuid: user uuid of person who invited</span>
<span class="sd">        :return:</span>

<span class="sd">        Refuse an invitation created with &#39;invite_user_to_group&#39;. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_id_from_uuid</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
        <span class="n">requesting_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">host_uuid</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_invite_to_group_exists</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
            <span class="c"># remove invitation without acting on it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_uninvite_user_to_group</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;no group invitation exists for user&quot;</span><span class="p">)</span>

    <span class="c">#  for now, couple group membership with group privilege</span>
    <span class="c"># self.assert_user_in_group(group_uuid, user_uuid)</span></div>
<div class="viewcode-block" id="HSAccess.share_group_with_user"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.share_group_with_user">[docs]</a>    <span class="k">def</span> <span class="nf">share_group_with_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">,</span> <span class="n">privilege_code</span><span class="o">=</span><span class="s">&#39;ro&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DEPRECATED: Attempt to share a group with a user: this allows read/write to the group membership list</span>

<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :type privilege_code: str</span>
<span class="sd">        :param group_uuid: group identifier of group to which privilege should be assigned</span>
<span class="sd">        :param user_uuid: uuid of user to whom privilege should be granted</span>
<span class="sd">        :param privilege_code: privilege to be granted.</span>
<span class="sd">        :return: None</span>

<span class="sd">        This routine has been replaced by the invite/accept/refuse/uninvite interface, including: </span>
<span class="sd">        * invite_user_to_group (for inviter) </span>
<span class="sd">        * uninvite_user_to_group (for inviter) </span>
<span class="sd">        * accept_invitation_to_group (for invitee) </span>
<span class="sd">        * refuse_invitation_to_group (for invitee) </span>
<span class="sd">        * get_invitations_to_group (for invitee) </span>

<span class="sd">        This is a direct sharing of a group without user permission. </span>

<span class="sd">        Preconditions: </span>

<span class="sd">        1. current user must have equivalent or stronger access to group (or admin privileges). </span>

<span class="sd">        Postconditions: </span>

<span class="sd">        2. User is made a member of the group at the chosen level.</span>

<span class="sd">        This may be repeated without harm to downgrade or upgrade members one has previously invited. </span>

<span class="sd">        :todo: not safe from removing last owner </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="n">privilege_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_privilege_id_from_code</span><span class="p">(</span><span class="n">privilege_code</span><span class="p">)</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_id_from_uuid</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
        <span class="n">requesting_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)</span>
        <span class="c"># sanity logic: no such thing as &#39;ns&#39; access.</span>
        <span class="k">if</span> <span class="n">privilege_code</span> <span class="o">==</span> <span class="s">&#39;ns&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;privilege &#39;readable without sharing&#39; does not apply to groups&quot;</span><span class="p">)</span>
        <span class="c"># access control logic: cannot grant sharing above own privilege</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)):</span>
            <span class="c"># use join to access privilege records</span>
            <span class="n">user_priv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_privilege_over_group</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user_priv</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PRIVILEGE_RO</span><span class="p">:</span>  <span class="c"># read-only or no-sharing</span>
                <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;user lacks read/write privilege necessary to share this group&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">user_priv</span> <span class="o">&gt;</span> <span class="n">privilege_id</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;user has insufficient privilege to share this group in this way&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_share_group_with_user</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">)</span>
        <span class="c"># for now, couple group membership with group privilege; the following is obsolete</span>
        <span class="c"># self.assert_user_in_group(group_uuid, user_uuid)</span>
</div>
    <span class="k">def</span> <span class="nf">_user_access_to_group_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: Test whether there is an access record for a specific user, group, and asserting user</span>

<span class="sd">        :type requesting_id: int</span>
<span class="sd">        :type user_id: int</span>
<span class="sd">        :type group_id: int</span>
<span class="sd">        :param requesting_id: user id of user assigning privilege</span>
<span class="sd">        :param user_id: user id of user who needs privilege</span>
<span class="sd">        :param group_id: group id of group to which privilege will be assigned</span>
<span class="sd">        :return: None</span>

<span class="sd">        This is a helper routine for &#39;share_group_with_user&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;select privilege_id from user_access_to_group where user_id=%s and group_id=%s</span>
<span class="sd">            and assertion_user_id=%s&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;Database integrity violation: more than one record for a group privilege triple&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_share_group_with_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: unpoliced share of group with user</span>

<span class="sd">        :type requesting_id: int</span>
<span class="sd">        :type user_id: int</span>
<span class="sd">        :type group_id: int</span>
<span class="sd">        :param requesting_id: internal id of requesting user </span>
<span class="sd">        :param user_id: internal id of user to gain privilege </span>
<span class="sd">        :param group_id: internal id of group to which to grant privilege </span>
<span class="sd">        :return:</span>

<span class="sd">        This is a helper routine for &#39;share_group_with_user&#39;. It does not have access control. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_access_to_group_exists</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_share_group_user_update</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_share_group_user_add</span><span class="p">(</span><span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_share_group_user_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: update user access to a group</span>

<span class="sd">        :type requesting_id: int</span>
<span class="sd">        :type user_id: int</span>
<span class="sd">        :type group_id: int</span>
<span class="sd">        :type privilege_id: int</span>
<span class="sd">        :param requesting_id: id of user requesting change</span>
<span class="sd">        :param user_id: id of user to be enabled</span>
<span class="sd">        :param group_id: id of group to be modified</span>
<span class="sd">        :param privilege_id: id of privilege to be installed</span>
<span class="sd">        :return: None</span>

<span class="sd">        This is a helper routine for &#39;share_group_with_user&#39;. It does not have access control. </span>
<span class="sd">        There must already be a privilege record for the user, group, and current user. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;update user_access_to_group set privilege_id = </span><span class="si">%s</span><span class="s">,</span>
<span class="s">                          assertion_time=CURRENT_TIMESTAMP where user_id=</span><span class="si">%s</span><span class="s"> and group_id=</span><span class="si">%s</span><span class="s"> and assertion_user_id=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">privilege_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_share_group_user_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: add new user access for a group</span>

<span class="sd">        :type requesting_id: int</span>
<span class="sd">        :type user_id: int</span>
<span class="sd">        :type group_id: int</span>
<span class="sd">        :type privilege_id: int</span>
<span class="sd">        :param requesting_id: int: id of user requesting change</span>
<span class="sd">        :param user_id: int: id of user to be enabled</span>
<span class="sd">        :param group_id: int: id of group to be modified</span>
<span class="sd">        :param privilege_id: int: id of privilege to be installed</span>
<span class="sd">        :return: None</span>

<span class="sd">        This is a helper routine for &#39;share_group_with_user&#39;. It does not have access control. </span>
<span class="sd">        There must not already be a privilege record for the user, group, and current user. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;insert into user_access_to_group values (DEFAULT, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, DEFAULT)&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">privilege_id</span><span class="p">,</span> <span class="n">requesting_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c"># CLI: hs group remove ...</span>
<div class="viewcode-block" id="HSAccess.unshare_group_with_user"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.unshare_group_with_user">[docs]</a>    <span class="k">def</span> <span class="nf">unshare_group_with_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempt to unshare a group with a user</span>

<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param group_uuid: group identifier of group for which privilege should be removed.</span>
<span class="sd">        :param user_uuid: uuid of user for whom privilege should be removed; omit for current user. </span>
<span class="sd">        :return: None</span>

<span class="sd">        There are three conditions under which one can unshare a group with a user, either: </span>

<span class="sd">        1. user has admin, or </span>

<span class="sd">        2. user owns the group, or</span>

<span class="sd">        3. user is the user in question and wishes to leave the group</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>

        <span class="c"># these serve as argument checks</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_id_from_uuid</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
        <span class="c"># requesting_id = self._get_user_id_from_uuid(self._user_uuid)</span>

        <span class="c"># access control logic:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)</span> \
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_is_owned</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span> \
                <span class="ow">or</span> <span class="p">(</span><span class="n">user_uuid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_in_group</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_of_group_owners</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_is_owned</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">,</span> <span class="n">user_uuid</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from user_access_to_group where group_id=</span><span class="si">%s</span><span class="s"> and user_id=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span>
                                  <span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;cannot remove last group owner&quot;</span><span class="p">)</span>
            <span class="c"># self.retract_user_from_group(user_uuid, group_uuid)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;insufficient privilege to unshare group &#39;&quot;</span>
                               <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_group_print_name</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
                               <span class="o">+</span> <span class="s">&quot;&#39; with user &#39;&quot;</span>
                               <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_print_name</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">))</span>

    <span class="c">###########################################################</span>
    <span class="c"># faceted information retrieval</span>
    <span class="c">###########################################################</span>
    <span class="c"># CLI: hs ls resources</span></div>
<div class="viewcode-block" id="HSAccess.resources_held_by_user"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.resources_held_by_user">[docs]</a>    <span class="k">def</span> <span class="nf">resources_held_by_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a list of resources held by user, sorted by title</span>

<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param user_uuid: uuid of user; omit for current user. </span>
<span class="sd">        :return: List of resources containing dict items</span>

<span class="sd">        This returns a list of resource dict records, in the format::</span>

<span class="sd">            {</span>
<span class="sd">            &#39;uuid&#39;: *uuid of resource*,</span>
<span class="sd">            &#39;title&#39;: *title of resource*,</span>
<span class="sd">            &#39;path&#39;: *path of resource*,</span>
<span class="sd">            &#39;privilege&#39;: *privilege code*</span>
<span class="sd">            }</span>
<span class="sd">           </span>
<span class="sd">        Note: this is not subject to access control. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select distinct r.resource_uuid, r.resource_title, r.resource_path, p.privilege_code</span>
<span class="s">          from user_resource_privilege u</span>
<span class="s">          left join resources r on r.resource_id = u.resource_id</span>
<span class="s">          left join privileges p on p.privilege_id = u.privilege_id</span>
<span class="s">          where user_id=</span><span class="si">%s</span><span class="s"> order by r.resource_uuid&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;resource_uuid&#39;</span><span class="p">],</span>
                           <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;resource_title&#39;</span><span class="p">],</span>
                           <span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;resource_path&#39;</span><span class="p">],</span>
                           <span class="s">&#39;privilege&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;privilege_code&#39;</span><span class="p">]})</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="HSAccess.resources_held_by_group"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.resources_held_by_group">[docs]</a>    <span class="k">def</span> <span class="nf">resources_held_by_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve resources accessible to a specific group</span>

<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :param group_uuid: uuid of the group to check</span>
<span class="sd">        :return: list: structure of resources</span>

<span class="sd">        This returns a list of resources accessible to a specific group, in the format::</span>

<span class="sd">            {</span>
<span class="sd">            &#39;uuid&#39;: *uuid of resource*,</span>
<span class="sd">            &#39;title&#39;: *title of resource*,</span>
<span class="sd">            &#39;path&#39;: *path of resource*,</span>
<span class="sd">            &#39;privilege&#39;: *privilege code*</span>
<span class="sd">            }</span>

<span class="sd">        Note: this is not subject to access control. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_id_from_uuid</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select r.resource_title, r.resource_uuid, r.resource_path, q.privilege_code</span>
<span class="s">                          from resources r inner join group_resource_privilege p</span>
<span class="s">                          on r.resource_id = p.resource_id</span>
<span class="s">                          left join privileges q on p.privilege_id = q.privilege_id</span>
<span class="s">                          where p.group_id = </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">group_id</span><span class="p">,))</span>
        <span class="c"># map this into a dict structure</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;resource_uuid&#39;</span><span class="p">],</span>
                           <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;resource_title&#39;</span><span class="p">],</span>
                           <span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;resource_path&#39;</span><span class="p">],</span>
                           <span class="s">&#39;privilege&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;privilege_code&#39;</span><span class="p">]})</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="c"># CLI: hs ls groups</span></div>
<div class="viewcode-block" id="HSAccess.groups_of_user"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.groups_of_user">[docs]</a>    <span class="k">def</span> <span class="nf">groups_of_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a list of groups in which a user is a member.</span>

<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param user_uuid: uuid of user, or None to use current authorized user </span>
<span class="sd">        :return: list of dict entries, one per group</span>

<span class="sd">        This returns a list of dictionaries, each of the form::</span>

<span class="sd">            {</span>
<span class="sd">            &#39;uuid&#39;: *group&#39;s uuid*, </span>
<span class="sd">            &#39;name&#39;: *group&#39;s name*</span>
<span class="sd">            }</span>

<span class="sd">        for use in displaying group data. </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># default to irods user if no uuid given</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select distinct g.group_uuid, g.group_name</span>
<span class="s">            from user_membership_in_group m left join groups g on m.group_id=g.group_id</span>
<span class="s">            where user_id=</span><span class="si">%s</span><span class="s"> order by g.group_name, g.group_uuid&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;group_uuid&#39;</span><span class="p">],</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;group_name&#39;</span><span class="p">]})</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c"># ##########################################################</span>
    <span class="c"># stubs for folder subsystem</span>
    <span class="c"># ##########################################################</span></div>
<div class="viewcode-block" id="HSAccess.assert_folder"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.assert_folder">[docs]</a>    <span class="k">def</span> <span class="nf">assert_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        STUB: Create a folder in the user_folders relation</span>

<span class="sd">        :type folder_name: str</span>
<span class="sd">        :param folder_name: The name of the folder</span>
<span class="sd">        :return: None</span>

<span class="sd">        Uses self._user_uuid: the identity of the current user.</span>
<span class="sd">        Folders are local to the current user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="HSAccess.retract_folder"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.retract_folder">[docs]</a>    <span class="k">def</span> <span class="nf">retract_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        STUB: Remove a folder; things in the folder become &quot;unfiled&quot;</span>

<span class="sd">        :type folder_name: str</span>
<span class="sd">        :param folder_name: The name of the folder</span>
<span class="sd">        :return: None</span>

<span class="sd">        Uses: self._user_uuid: the identity of the current user.</span>
<span class="sd">        Folders are local to the current user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="HSAccess.assert_resource_in_folder"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.assert_resource_in_folder">[docs]</a>    <span class="k">def</span> <span class="nf">assert_resource_in_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        STUB: Put a resource into a previously created folder</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :type folder_name: str</span>
<span class="sd">        :param resource_uuid: identifier of resource to put into folder</span>
<span class="sd">        :param folder_name: name of the folder</span>
<span class="sd">        :return: None</span>

<span class="sd">        Uses self._user_uuid: the identity of the current user.</span>
<span class="sd">        Folders are local to the current user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="HSAccess.retract_resource_in_folder"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.retract_resource_in_folder">[docs]</a>    <span class="k">def</span> <span class="nf">retract_resource_in_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        STUB: Remove a resource from a folder; it becomes unfiled.</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :type folder_name: str</span>
<span class="sd">        :param resource_uuid: identifier of resource to put into folder</span>
<span class="sd">        :param folder_name: name of the folder</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="HSAccess.get_folders"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_folders">[docs]</a>    <span class="k">def</span> <span class="nf">get_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        STUB: Return a list of folders for this user</span>

<span class="sd">        :return: A list of folder names</span>

<span class="sd">        Uses self._user_uuid: current user identity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="HSAccess.get_resources_in_folders"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_resources_in_folders">[docs]</a>    <span class="k">def</span> <span class="nf">get_resources_in_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        STUB: Get a structured dictionary of folders and their contents</span>

<span class="sd">        :type folder: str</span>
<span class="sd">        :param folder: the optional name of a folder to use as the top of the hierarchy</span>
<span class="sd">        :return: A dict object of contents</span>

<span class="sd">        Uses self._user_uuid: the current user.</span>

<span class="sd">        This returns a dictionary structure of the form::</span>

<span class="sd">            { folder: { resource_uuid : { title : *resource title*, &#39;access&#39; : *access code* }}}</span>

<span class="sd">        1. If folder is None, report on the whole hierarchy of user folders </span>

<span class="sd">        2.  If folder is not None, report on only one chosen folder.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>

    <span class="c"># ##########################################################</span>
    <span class="c"># stubs for tag subsystem</span>
    <span class="c"># ##########################################################</span></div>
<div class="viewcode-block" id="HSAccess.assert_tag"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.assert_tag">[docs]</a>    <span class="k">def</span> <span class="nf">assert_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        STUB: Create a tag in the user_tags relation</span>

<span class="sd">        :type tag_name: str</span>
<span class="sd">        :param tag_name: The name of the tag</span>
<span class="sd">        :return: None</span>

<span class="sd">        Uses self._user_uuid: the identity of the current user.</span>

<span class="sd">        Registers a tag for later uses. This assures that tags are unambiguous when applied. </span>
<span class="sd">        Folders are local to the current user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="HSAccess.retract_tag"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.retract_tag">[docs]</a>    <span class="k">def</span> <span class="nf">retract_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        STUB: Remove a tag; things in the tag become &quot;untagged&quot;</span>

<span class="sd">        :type tag_name: str</span>
<span class="sd">        :param tag_name: The name of the tag</span>
<span class="sd">        :return: None</span>

<span class="sd">        Uses self._user_uuid: the identity of the current user.</span>

<span class="sd">        Unregisters a tag along with all of uses of that tag on resources. </span>
<span class="sd">        Folders are local to the current user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="HSAccess.assert_resource_has_tag"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.assert_resource_has_tag">[docs]</a>    <span class="k">def</span> <span class="nf">assert_resource_has_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        STUB: Assign a resource a previously created tag</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :type tag_name: str</span>
<span class="sd">        :param resource_uuid: identifier of resource to put into tag</span>
<span class="sd">        :param tag_name: name of the tag</span>
<span class="sd">        :return: None</span>

<span class="sd">        Uses self._user_uuid: the identity of the current user.</span>
<span class="sd">        Tags are local to the current user.</span>
<span class="sd">        Multiple asserts with different tags apply all of them</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="HSAccess.retract_resource_has_tag"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.retract_resource_has_tag">[docs]</a>    <span class="k">def</span> <span class="nf">retract_resource_has_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        STUB: Remove a tag from a resource; it becomes untagged.</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :type tag_name: str</span>
<span class="sd">        :param resource_uuid: identifier of resource to put into tag</span>
<span class="sd">        :param tag_name: name of the tag</span>
<span class="sd">        :return: None</span>

<span class="sd">        Uses self._user_uuid: the identity of the current user.</span>
<span class="sd">        Tags are local to the current user.</span>
<span class="sd">        This removes an assertion of one tag while leaving the others alone. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="HSAccess.get_tags"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_tags">[docs]</a>    <span class="k">def</span> <span class="nf">get_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        STUB: Return a list of tags for this user</span>

<span class="sd">        :return: A list of tag names</span>

<span class="sd">        Uses self._user_uuid: current user identity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="HSAccess.get_resources_by_tag"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_resources_by_tag">[docs]</a>    <span class="k">def</span> <span class="nf">get_resources_by_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        STUB: Get a structured dictionary of tags and their contents</span>

<span class="sd">        :type tag: str</span>
<span class="sd">        :param tag: the name of a tag to use</span>
<span class="sd">        :return: A dict object of contents</span>

<span class="sd">        Uses: self._user_uuid: the current user.</span>
<span class="sd">        This returns a dictionary structure of the form::</span>

<span class="sd">            { &quot;tag&quot;: { resource_uuid : { title : *resource title*, &#39;access&#39; : *access code* }}}</span>

<span class="sd">        If tag argument is not None, report on only one tag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>

    <span class="c">####################################################################</span>
    <span class="c"># statistics</span>
    <span class="c">####################################################################</span>
</div>
<div class="viewcode-block" id="HSAccess.get_number_of_resource_owners"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_number_of_resource_owners">[docs]</a>    <span class="k">def</span> <span class="nf">get_number_of_resource_owners</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count the number of resource owners for a resource, for reporting purposes. </span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :param resource_uuid: identifier of resource to report upon </span>
<span class="sd">        :return: int: number of owners</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_exists</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;resource uuid &#39;&quot;</span> <span class="o">+</span> <span class="n">resource_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>
        <span class="n">resource_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resource_id_from_uuid</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select count(distinct user_id) as count from user_resource_privilege</span>
<span class="s">                          where resource_id=</span><span class="si">%s</span><span class="s"> and privilege_id=1&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">resource_id</span><span class="p">,))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;count&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="HSAccess.get_number_of_group_owners"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_number_of_group_owners">[docs]</a>    <span class="k">def</span> <span class="nf">get_number_of_group_owners</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count the number of resource owners for a resource, for reporting purposes. </span>

<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :param group_uuid: identifier of group to report upon </span>
<span class="sd">        :return: int: number of owners</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_exists</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;group uuid &#39;&quot;</span> <span class="o">+</span> <span class="n">group_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>
        <span class="n">resource_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_id_from_uuid</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select count(distinct user_id) as count from user_group_privilege</span>
<span class="s">                          where group_id=</span><span class="si">%s</span><span class="s"> and privilege_id=1&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">resource_id</span><span class="p">,))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;count&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="HSAccess.get_number_of_resources_owned_by_user"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_number_of_resources_owned_by_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_number_of_resources_owned_by_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count the number of resources owned by a user. </span>

<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param user_uuid: identifier of group to report upon; None reports upon current user </span>
<span class="sd">        :return: int: number of resources owned</span>

<span class="sd">        Note: this reports on any user independent of the privilege of the current user. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;user uuid &#39;&quot;</span> <span class="o">+</span> <span class="n">user_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select count(distinct resource_id) as count from user_resource_privilege</span>
<span class="s">                          where user_id=</span><span class="si">%s</span><span class="s"> and privilege_id=1&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">user_id</span><span class="p">,))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;count&#39;</span><span class="p">]</span>

    <span class="c"># get the number of groups the user owns</span></div>
<div class="viewcode-block" id="HSAccess.get_number_of_groups_owned_by_user"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_number_of_groups_owned_by_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_number_of_groups_owned_by_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count the number of groups owned by a user. </span>

<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param user_uuid: identifier of group to report upon; None reports upon current user </span>
<span class="sd">        :return: int: number of groups owned</span>

<span class="sd">        Note: this reports on any user independent of the privilege of the current user. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;user uuid &#39;&quot;</span> <span class="o">+</span> <span class="n">user_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select count(distinct group_id) as count from user_group_privilege</span>
<span class="s">                          where user_id=</span><span class="si">%s</span><span class="s"> and privilege_id=1&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">user_id</span><span class="p">,))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;count&#39;</span><span class="p">]</span>

    <span class="c"># measure the number of resources the user can access</span></div>
<div class="viewcode-block" id="HSAccess.get_number_of_resources_held_by_user"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_number_of_resources_held_by_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_number_of_resources_held_by_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count the number of resources held by a user. </span>

<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param user_uuid: identifier of group to report upon; None reports upon current user </span>
<span class="sd">        :return: int: number of resources held</span>

<span class="sd">        Note: this reports on any user independent of the privilege of the current user. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;user uuid &#39;&quot;</span> <span class="o">+</span> <span class="n">user_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select count(distinct resource_id) as count from user_resource_privilege</span>
<span class="s">                          where user_id=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">user_id</span><span class="p">,))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;count&#39;</span><span class="p">]</span>

    <span class="c"># measure the number of resources the user can access</span>
    <span class="c"># note: group membership and access are currently synonymous</span>
    <span class="c"># I am utilizing group access as the count.</span>
</div>
<div class="viewcode-block" id="HSAccess.get_number_of_groups_of_user"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_number_of_groups_of_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_number_of_groups_of_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count the number of groups in which a user is a member</span>

<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param user_uuid: identifier of group to report upon; None reports upon current user </span>
<span class="sd">        :return: int: number of groups joined </span>

<span class="sd">        Note: this reports on any user independent of the privilege of the current user. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;user uuid &#39;&quot;</span> <span class="o">+</span> <span class="n">user_uuid</span> <span class="o">+</span> <span class="s">&quot;&#39; does not exist&quot;</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id_from_uuid</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select count(distinct group_id) as count from user_group_privilege</span>
<span class="s">                          where user_id=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">user_id</span><span class="p">,))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;count&#39;</span><span class="p">]</span>

    <span class="c">##################################################################################</span>
    <span class="c"># quick utility routines for obtaining current user information</span>
    <span class="c">##################################################################################</span>
</div>
<div class="viewcode-block" id="HSAccess.get_uuid"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_uuid">[docs]</a>    <span class="k">def</span> <span class="nf">get_uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the uuid of the current user </span>

<span class="sd">        :return: str: uuid of current user </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
</div>
<div class="viewcode-block" id="HSAccess.get_login"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_login">[docs]</a>    <span class="k">def</span> <span class="nf">get_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the (iRODS) login name of the current user </span>

<span class="sd">        :return: str: login name of current user </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_irods_user</span>
</div>
<div class="viewcode-block" id="HSAccess.get_user_print_name"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_user_print_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_print_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs a print name for any given user</span>

<span class="sd">        :type user_uuid: str</span>
<span class="sd">        :param user_uuid: identifier of user, None for current user </span>
<span class="sd">        :return: str: print name for requested user </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_uuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_metadata</span><span class="p">(</span><span class="n">user_uuid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;(&#39;</span> <span class="o">+</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;uuid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;)&#39;</span>
</div>
<div class="viewcode-block" id="HSAccess.get_resource_print_name"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_resource_print_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_resource_print_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs a print name for any given resource</span>

<span class="sd">        :type resource_uuid: str</span>
<span class="sd">        :param resource_uuid: identifier of resource</span>
<span class="sd">        :return: str: print name for requested resource </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resource_metadata</span><span class="p">(</span><span class="n">resource_uuid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;(&#39;</span> <span class="o">+</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;uuid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;)&#39;</span>
</div>
<div class="viewcode-block" id="HSAccess.get_group_print_name"><a class="viewcode-back" href="../module.html#HSAlib.HSAccess.get_group_print_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_group_print_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs a print name for any given group</span>

<span class="sd">        :type group_uuid: str</span>
<span class="sd">        :param group_uuid: identifier of group</span>
<span class="sd">        :return: str: print name for requested group </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_group_metadata</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;(&#39;</span> <span class="o">+</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;uuid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;)&#39;</span>

    <span class="c">#################################################</span>
    <span class="c"># reset everything for testing</span>
    <span class="c">#################################################</span>
</div>
    <span class="k">def</span> <span class="nf">_global_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">are_you_sure</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PRIVATE: Delete all data from the database except for starting situation, for testing.</span>

<span class="sd">        :type are_you_sure: str</span>
<span class="sd">        :param are_you_sure: a string that must have the value &quot;yes, I&#39;m sure&quot;</span>

<span class="sd">        This clears the database to an install state. This is used for testing,</span>
<span class="sd">        and never in production. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_uuid</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">are_you_sure</span> <span class="o">==</span> <span class="s">&quot;yes, I&#39;m sure&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from user_tags_of_resource&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from user_folder_of_resource&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from group_access_to_resource&quot;</span><span class="p">)</span>
                <span class="c"># self._cur.execute(&quot;delete from user_membership_in_group&quot;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from user_invitations_to_group&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from user_access_to_group&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from user_access_to_resource&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from user_folders&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from user_tags&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from groups&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from resources&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from users where user_id != 1&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HSAException</span><span class="p">(</span><span class="s">&quot;operation requires admin privilege&quot;</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">IrodsShare 0.1 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Alva Couch et al..
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>